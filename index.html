<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookBlue</title>
  <!-- 添加全局变量来跟踪库加载状态 -->
  <script>
    window.librariesReady = false;
    window.librariesLoading = true;
  </script>

  <!-- 引入JSZip库 - ePub.js的依赖 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- 引入ePub.js库 -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- 库加载管理 -->
  <script>
    // 检查库是否已加载
    function checkLibraries() {
      const jszipLoaded = typeof JSZip !== 'undefined';
      const epubLoaded = typeof ePub !== 'undefined';

      if (jszipLoaded && epubLoaded) {

        window.librariesReady = true;
        window.librariesLoading = false;

        // 更新UI状态
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }

        const dropArea = document.getElementById('drop-area');
        if (dropArea) {
          dropArea.classList.remove('disabled');
          const loadingText = dropArea.querySelector('.loading-text');
          if (loadingText) {
            loadingText.style.display = 'none';
          }
        }

        return true;
      }

      return false;
    }

    // 尝试加载备用库源
    function loadAlternateLibraries() {
      if (typeof JSZip === 'undefined') {
        var jszipScript = document.createElement('script');
        jszipScript.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
        jszipScript.onload = function() {
          checkLibraries();
        };
        document.head.appendChild(jszipScript);
      }

      if (typeof ePub === 'undefined') {
        var epubScript = document.createElement('script');
        epubScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js';
        epubScript.onload = function() {
          checkLibraries();
        };
        document.head.appendChild(epubScript);
      }
    }

    // 页面加载完成后检查库
    window.addEventListener('load', function() {
      if (!checkLibraries()) {
        loadAlternateLibraries();

        // 5秒后再次检查
        setTimeout(function() {
          if (!window.librariesReady) {
            console.error('Failed to load libraries after timeout');
            alert('Failed to load required libraries. Please check your internet connection and try again.');
          }
        }, 5000);
      }
    });
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Serif', Georgia, serif;
      background-color: #f5f2e9;
      height: 100vh;
      overflow: hidden;
    }

    /* Dropbox 授权按钮样式 */
    #dropbox-auth-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      padding: 5px 10px;
      background-color: #0061fe;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Dropbox URL 显示区域样式 */
    #dropbox-auth-url {
      position: absolute;
      top: 45px;
      left: 10px;
      z-index: 1000;
      max-width: 500px;
      padding: 5px;
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 10px;
      word-break: break-all;
      display: none;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    .reader-area {
      flex: 1;
      height: 100%;
      position: relative;
      background-color: #fff;
      overflow: hidden;
      cursor: default; /* 使用默认光标，不显示文本选择光标 */
    }

    .notes-area {
      width: 30px; /* 默认收起状态的宽度 */
      background-color: #f5f2e9;
      height: 100%;
      position: relative;
      transition: width 0.3s ease;
      overflow: hidden;
      box-shadow: -1px 0 3px rgba(0, 0, 0, 0.05);
    }

    .notes-area.expanded {
      width: 350px; /* 展开状态的宽度 */
    }

    .notes-toggle {
      position: absolute;
      left: 0;
      top: 0;
      width: 30px;
      height: 100%;
      background-color: #f5f2e9;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .notes-toggle:hover {
      background-color: #ebe5d6;
    }

    .notes-toggle::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: 2px;
      background-color: #4a4238;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .notes-toggle:hover::after {
      opacity: 0.15;
    }

    .notes-toggle .icon {
      font-size: 16px;
      color: #8a7a6a;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.7;
      transition: opacity 0.2s ease, color 0.2s ease;
    }

    .notes-toggle:hover .icon {
      opacity: 1;
      color: #4a4238;
    }

    .notes-content {
      position: absolute;
      left: 30px;
      top: 0;
      width: calc(100% - 30px);
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s;
    }

    .notes-area.expanded .notes-content {
      opacity: 1;
      visibility: visible;
    }

    #epub-container {
      width: 100%;
      height: calc(100% - 30px); /* 减少高度，为页码留出空间 */
      position: relative;
      overflow: hidden;
    }

    .drop-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.9);
      border: 3px dashed #ccc;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .drop-area.hidden {
      display: none;
    }

    .drop-area.disabled {
      opacity: 0.7;
      pointer-events: none;
      border-color: #999;
    }

    .loading-indicator {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4a4238;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .loading-indicator::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    .loading-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a4238;
      font-size: 1.2rem;
      z-index: 2;
    }

    /* 页码显示 - 极简风格，只有数字 */
    .page-counter {
      position: absolute;
      bottom: 8px;
      right: 15px;
      font-size: 14px;
      color: #4a4238;
      z-index: 10;
      user-select: none;
    }

    .plus-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #4a4238;
      color: white;
      margin: 0 auto;
    }

    .plus-icon {
      font-size: 3rem;
      line-height: 1;
      display: block;
    }

    #file-input {
      display: none;
    }

    #select-file-btn {
      padding: 0.7rem 1.2rem;
      background-color: #4a4238;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #select-file-btn:hover {
      background-color: #5d5347;
    }

    #notes {
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      resize: none;
      font-family: inherit;
      background-color: transparent;
      line-height: 1.6;
      border: none;
      outline: none;
      color: #4a4238;
      box-sizing: border-box;
    }

    /* 极简界面，移除了页面信息样式 */

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .notes-area {
        width: 100%;
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Dropbox 授权按钮 -->
  <button id="dropbox-auth-button">连接 Dropbox</button>

  <!-- Dropbox 授权 URL 显示区域 -->
  <div id="dropbox-auth-url"></div>

  <div class="container">
    <div class="reader-area">
      <!-- 单一容器用于ePub.js渲染 -->
      <div id="epub-container"></div>

      <!-- 加载指示器 -->
      <div id="loading-indicator" class="loading-indicator">Loading libraries</div>

      <!-- 页码显示 -->
      <div id="page-counter" class="page-counter"></div>

      <!-- 移除了紧急翻页按钮 -->

      <div id="drop-area" class="drop-area disabled">
        <div class="loading-text">Loading...</div>
        <div class="plus-container">
          <span class="plus-icon">+</span>
        </div>
      </div>
      <!-- 极简界面，移除了导航条 -->
    </div>

    <div class="notes-area" id="notes-area">
      <div class="notes-toggle" id="notes-toggle">
        <span class="icon">></span>
      </div>
      <div class="notes-content">
        <textarea id="notes" placeholder="Click here to write your notes..."></textarea>
      </div>
    </div>
  </div>

  <script>
    // Dropbox 配置
    // 注意：如果您要在其他设备上使用，请修改以下配置
    const dropboxConfig = {
      // 您的 Dropbox 应用密钥 (https://www.dropbox.com/developers/apps)
      clientId: '6swvs08dx2uakdi',

      // 重定向 URI - 默认使用当前页面的 origin (协议+主机名+端口)
      // 您也可以手动设置为固定值，如 'http://localhost:8000'
      get redirectUri() {
        return window.location.origin;
      }
    };

    // Dropbox 授权函数
    async function handleDropboxAuth() {
      console.log('开始 Dropbox 授权流程...');

      try {
        // 获取重定向 URL
        const redirectUrl = dropboxConfig.redirectUri;
        console.log(`使用重定向 URL: ${redirectUrl}`);

        // 生成随机状态参数，防止 CSRF 攻击
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem('dropboxAuthState', state);

        // 构建授权 URL
        const authUrl = new URL('https://www.dropbox.com/oauth2/authorize');
        authUrl.searchParams.append('client_id', dropboxConfig.clientId);
        authUrl.searchParams.append('response_type', 'code');
        authUrl.searchParams.append('redirect_uri', redirectUrl);
        authUrl.searchParams.append('state', state);
        authUrl.searchParams.append('scope', 'files.content.read files.content.write files.metadata.read');
        authUrl.searchParams.append('token_access_type', 'offline');

        // 显示授权 URL
        const authUrlString = authUrl.toString();
        const urlDisplay = document.getElementById('dropbox-auth-url');
        urlDisplay.textContent = authUrlString;
        urlDisplay.style.display = 'block';
        console.log(`授权 URL: ${authUrlString}`);

        // 不自动跳转，让用户可以看到 URL
        // window.location.href = authUrlString;
      } catch (error) {
        console.error('生成授权 URL 时出错:', error);
      }
    }

    // 处理授权重定向
    function handleDropboxRedirect() {
      console.log('检查 URL 中是否有授权码...');

      // 检查 URL 中是否包含授权码
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');

      // 检查是否有错误
      if (error) {
        console.log(`授权失败: ${error}`);
        return;
      }

      // 验证状态参数
      const savedState = localStorage.getItem('dropboxAuthState');
      if (state && savedState && state !== savedState) {
        console.log('状态参数不匹配，可能是 CSRF 攻击');
        return;
      }

      if (authCode) {
        console.log('从 URL 中获取到授权码');
        console.log(`授权码: ${authCode}`);

        // 清除 URL 中的授权码
        window.history.replaceState(null, null, window.location.pathname);

        // 在实际应用中，这里应该发送请求到服务器，用授权码交换访问令牌
        console.log('在实际应用中，这里应该用授权码交换访问令牌');

        // 清除状态参数
        localStorage.removeItem('dropboxAuthState');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 绑定 Dropbox 授权按钮事件
      const dropboxAuthButton = document.getElementById('dropbox-auth-button');
      if (dropboxAuthButton) {
        dropboxAuthButton.addEventListener('click', handleDropboxAuth);
      }

      // 检查 URL 中是否有授权码
      handleDropboxRedirect();

      // 检查ePub.js是否正确加载
      if (typeof ePub === 'undefined') {
        alert('Error: ePub.js library could not be loaded. Please check your internet connection and try again.');
        return;
      }
      // 获取DOM元素
      const dropArea = document.getElementById('drop-area');
      const epubViewer = document.getElementById('epub-viewer');
      const notesTextarea = document.getElementById('notes');
      const notesArea = document.getElementById('notes-area');
      const notesToggle = document.getElementById('notes-toggle');
      // 移除了调试按钮相关变量
      // 移除了紧急导航按钮相关变量

      // 全局变量
      let book;
      let rendition;  // 渲染器
      let currentBook = null;
      let currentNotes = {};
      let currentLocation = 0; // 当前位置
      let totalLocations = 0;  // 总位置数

      // 更新页面显示 - 全局函数
      function updatePages(startLocation) {
        // 确保位置在有效范围内
        if (startLocation < 0) startLocation = 0;
        if (startLocation >= totalLocations) startLocation = totalLocations - 1;

        // 更新当前位置
        currentLocation = startLocation;

        // 使用位置索引（转换为CFI）
        const cfi = book.locations.cfiFromLocation(startLocation);

        // 显示页面
        rendition.display(cfi).then(() => {
          // 更新进度显示
          updateProgressInfo();

          // 保存阅读进度
          if (currentBook) {
            localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());
          }
        }).catch(error => {
          console.error('页面显示错误:', error);
        });
      }

      // 更新进度信息显示
      function updateProgressInfo() {
        if (!book || !rendition) return;

        try {
          // 计算百分比进度
          const percentage = Math.floor((currentLocation / totalLocations) * 100);

          // 构建进度信息
          let progressInfo = `${percentage}%`;

          // 添加位置信息
          progressInfo += ` | 位置: ${currentLocation+1}/${totalLocations}`;

          // 尝试获取当前章节信息
          try {
            const currentLoc = rendition.location;
            if (currentLoc && currentLoc.start) {
              // 获取章节路径
              const chapter = currentLoc.start.href || '';

              // 从章节路径中提取章节名称
              let chapterName = chapter.split('/').pop().replace('.html', '');

              // 尝试清理章节名称（移除数字前缀等）
              chapterName = chapterName.replace(/^\d+[\._-]?/, '');
              chapterName = chapterName.replace(/_/g, ' ');

              if (chapterName) {
                progressInfo += ` | ${chapterName}`;
              }

              // 尝试获取章节标题
              if (currentLoc.start.index) {
                const spineItem = book.spine.get(currentLoc.start.index);
                if (spineItem && spineItem.title) {
                  progressInfo += ` (${spineItem.title})`;
                }
              }
            }
          } catch (e) {
            // 忽略章节获取错误
          }

          // 更新页面信息显示
          const pageInfoElement = document.getElementById('page-info');
          if (pageInfoElement) {
            pageInfoElement.textContent = progressInfo;
          }

          // 更新右下角页码显示
          const pageCounterElement = document.getElementById('page-counter');
          if (pageCounterElement) {
            // 简洁显示：当前页/总页数
            pageCounterElement.textContent = `${currentLocation+1}/${totalLocations}`;
          }
        } catch (error) {
          console.error('更新进度信息出错:', error);
        }
      }

      // 将updateProgressInfo函数添加到window对象，使其在所有作用域中可用
      window.updateProgressInfo = updateProgressInfo;

      // 加载保存的笔记
      try {
        const savedNotes = localStorage.getItem('epub-reader-notes');
        if (savedNotes) {
          currentNotes = JSON.parse(savedNotes);
        }
      } catch (error) {
        console.error('Error loading saved notes:', error);
      }

      // 处理拖放事件 - 简化版本
      // 为整个文档添加拖放事件
      document.addEventListener('dragover', function(event) {
        event.preventDefault();

        // 如果库未加载完成，不处理
        if (!window.librariesReady) return;

        // 显示拖放区域
        if (dropArea.classList.contains('hidden')) {
          dropArea.classList.remove('hidden');
        }

        // 设置样式
        dropArea.style.borderColor = '#4a4238';
        dropArea.style.backgroundColor = 'rgba(74, 66, 56, 0.1)';
      });

      document.addEventListener('dragleave', function(event) {
        // 如果库未加载完成，不处理
        if (!window.librariesReady) return;

        // 重置样式
        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
      });

      document.addEventListener('drop', function(event) {
        event.preventDefault();

        // 如果库未加载完成，显示提示
        if (!window.librariesReady) {
          alert('Libraries are still loading. Please wait a moment and try again.');
          console.log('Error: Libraries not ready yet');
          return;
        }

        // 重置样式
        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';

        try {
          // 获取拖放的文件
          const file = event.dataTransfer.files[0];
          if (file && file.name.toLowerCase().endsWith('.epub')) {
            // 使用setTimeout延迟执行，给浏览器时间处理UI更新
            setTimeout(function() {
              try {
                // 处理新文件
                handleFile(file);
              } catch (error) {
                console.error('处理文件时出错:', error);
              }
            }, 100);
          }
        } catch (error) {
          console.error('处理拖放事件时出错:', error);
        }
      });

      // 为dropArea也添加事件监听器（确保兼容性）
      dropArea.addEventListener('dragover', function(event) {
        event.preventDefault();

        if (!window.librariesReady) return;

        dropArea.style.borderColor = '#4a4238';
        dropArea.style.backgroundColor = 'rgba(74, 66, 56, 0.1)';
      });

      dropArea.addEventListener('dragleave', function() {
        if (!window.librariesReady) return;

        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
      });

      dropArea.addEventListener('drop', function(event) {
        event.preventDefault();

        if (!window.librariesReady) {
          alert('Libraries are still loading. Please wait a moment and try again.');
          console.log('Error: Libraries not ready yet');
          return;
        }

        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';

        try {
          const file = event.dataTransfer.files[0];
          if (file && file.name.toLowerCase().endsWith('.epub')) {
            // 处理新文件
            handleFile(file);
          }
        } catch (error) {
          console.error('处理拖放事件时出错:', error);
        }
      });

      // 移除了示例EPUB加载功能

      // 设置自动保存笔记
      notesTextarea.addEventListener('input', function() {
        if (currentBook) {
          currentNotes[currentBook] = notesTextarea.value;
          localStorage.setItem('epub-reader-notes', JSON.stringify(currentNotes));
        }
      });

      // 添加笔记区域的焦点状态管理
      let isNotesActive = false; // 全局变量，跟踪笔记区域是否处于活动状态

      // 当笔记区域获得焦点时
      notesTextarea.addEventListener('focus', function() {
        isNotesActive = true;
        // 可以在这里添加视觉提示，例如改变边框颜色
        notesTextarea.style.outline = '2px solid #4a4238';
      });

      // 当笔记区域失去焦点时
      notesTextarea.addEventListener('blur', function() {
        isNotesActive = false;
        // 移除视觉提示
        notesTextarea.style.outline = 'none';

        // 自动保存笔记内容
        if (currentBook) {
          currentNotes[currentBook] = notesTextarea.value;
          localStorage.setItem('epub-reader-notes', JSON.stringify(currentNotes));
        }
      });

      // 更新笔记区域的箭头方向
      function updateNotesToggleIcon(isExpanded) {
        const icon = notesToggle.querySelector('.icon');
        if (isExpanded) {
          icon.textContent = '<'; // 展开状态显示左箭头（指向收起方向）
        } else {
          icon.textContent = '>'; // 收起状态显示右箭头（指向展开方向）
        }
      }

      // 设置笔记区域的展开状态
      function setNotesAreaExpanded(isExpanded, rerender = true) {
        // 更新DOM状态
        if (isExpanded) {
          notesArea.classList.add('expanded');
        } else {
          notesArea.classList.remove('expanded');
        }

        // 更新箭头方向
        updateNotesToggleIcon(isExpanded);

        // 保存状态到本地存储
        localStorage.setItem('notes-expanded', isExpanded ? 'true' : 'false');

        // 如果需要重新渲染，且书籍和渲染器已加载
        if (rerender && book && rendition) {
          // 使用实时渲染 - 在过渡动画期间每50ms渲染一次
          let animationTime = 0;
          const animationDuration = 300; // 过渡动画持续时间
          const renderInterval = 50; // 每50ms渲染一次

          // 清除可能存在的旧定时器
          if (window.notesAnimationTimer) {
            clearInterval(window.notesAnimationTimer);
          }

          // 设置定时器，在过渡动画期间定期渲染
          window.notesAnimationTimer = setInterval(() => {
            // 获取当前容器尺寸
            const container = document.getElementById('epub-container');
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;

            // 调整渲染器尺寸
            rendition.resize(newWidth, newHeight);

            // 使用当前位置重新渲染
            try {
              const location = rendition.location;
              if (location && location.start) {
                rendition.display(location.start.cfi);
              } else {
                // 如果无法获取当前位置，使用保存的位置
                const cfi = book.locations.cfiFromLocation(currentLocation);
                rendition.display(cfi);
              }
            } catch (error) {
              // 使用保存的位置
              const cfi = book.locations.cfiFromLocation(currentLocation);
              rendition.display(cfi);
            }

            // 更新动画时间
            animationTime += renderInterval;

            // 如果动画结束，清除定时器
            if (animationTime >= animationDuration) {
              clearInterval(window.notesAnimationTimer);
              window.notesAnimationTimer = null;
            }
          }, renderInterval);
        }
      }

      // 处理笔记区域的展开/收起
      notesToggle.addEventListener('click', function() {
        const isExpanded = !notesArea.classList.contains('expanded');
        setNotesAreaExpanded(isExpanded);
      });

      // 恢复笔记区域状态
      function restoreNotesAreaState() {
        const expanded = localStorage.getItem('notes-expanded') === 'true';
        setNotesAreaExpanded(expanded, false); // 不重新渲染，因为此时书籍可能尚未加载
      }

      // 页面加载时恢复笔记区域状态
      restoreNotesAreaState();

      // 卸载当前书籍 - 极简版本
      function unloadCurrentBook() {
        try {
          // 保存当前笔记
          if (currentBook && notesTextarea) {
            currentNotes[currentBook] = notesTextarea.value;
            localStorage.setItem('epub-reader-notes', JSON.stringify(currentNotes));
          }

          // 保存当前阅读进度
          if (currentBook && currentLocation >= 0) {
            localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());
          }

          // 清空容器 - 这是最重要的部分
          const epubContainer = document.getElementById('epub-container');
          if (epubContainer) {
            epubContainer.innerHTML = '';
          }

          // 简单地重置变量，不尝试清理对象
          book = null;
          rendition = null;

          // 强制垃圾回收（尽管这不是直接的方法）
          if (window.gc) {
            window.gc();
          }

        } catch (e) {
          console.error('卸载书籍时出错:', e);

          // 即使出错，也要确保容器被清空
          try {
            const epubContainer = document.getElementById('epub-container');
            if (epubContainer) {
              epubContainer.innerHTML = '';
            }

            // 重置变量
            book = null;
            rendition = null;
          } catch (innerError) {
            console.error('清空容器时出错:', innerError);
          }
        }
      }

      // 处理文件
      function handleFile(file) {
        // 检查库是否已加载
        if (!window.librariesReady) {
          alert('Libraries are still loading. Please wait a moment and try again.');
          return;
        }

        // 检查是否是EPUB文件
        if (!file.name.toLowerCase().endsWith('.epub')) {
          alert('Please upload an EPUB file.');
          return;
        }

        // 如果当前已有书籍加载，先卸载它
        unloadCurrentBook();

        // 设置当前书籍
        currentBook = file.name;

        // 隐藏拖放区域
        dropArea.classList.add('hidden');

        try {
          // 检查JSZip是否已加载
          if (typeof JSZip === 'undefined') {
            throw new Error('JSZip library is not loaded. Cannot process EPUB file.');
          }

          // 检查ePub.js是否已加载
          if (typeof ePub === 'undefined') {
            throw new Error('ePub.js library is not loaded. Cannot process EPUB file.');
          }

          try {
            // 创建book对象
            book = ePub();

            // 添加必要的事件监听器
            book.on('rendition:error', function(error) {
              console.error('渲染错误:', error);
            });

            // 使用FileReader读取文件为ArrayBuffer
            const reader = new FileReader();

            reader.onload = function(e) {
              const arrayBuffer = e.target.result;

              // 使用ArrayBuffer打开文件
              book.open(arrayBuffer)
                .then(function() {
                // 清空容器，确保没有残留内容
                const epubContainer = document.getElementById('epub-container');
                if (epubContainer) {
                  epubContainer.innerHTML = '';
                } else {
                  console.error('找不到epub-container元素，无法清空内容');
                }

                // 获取容器尺寸
                const container = document.getElementById('epub-container');
                const containerWidth = container ? container.clientWidth : 0;
                const containerHeight = container ? container.clientHeight : 0;
                rendition = book.renderTo('epub-container', {
                  width: containerWidth,
                  height: containerHeight,
                  spread: 'both',  // 启用双页显示
                  flow: 'paginated',
                  manager: 'default',
                  allowScriptedContent: true,
                  allowPopups: false,
                });

                // 生成位置信息
                book.ready.then(() => {
                  // 检查是否有保存的位置信息
                  const storedLocations = localStorage.getItem(`${currentBook}-locations`);

                  if (storedLocations) {
                    // 如果有保存的位置信息，直接加载
                    return book.locations.load(JSON.parse(storedLocations));
                  } else {
                    // 否则生成新的位置信息
                    return book.locations.generate(1024).then(locations => {
                      // 保存位置信息到本地存储
                      localStorage.setItem(`${currentBook}-locations`, JSON.stringify(locations));
                      return locations;
                    });
                  }
                }).then((locations) => {
                  totalLocations = book.locations.total;

                  // 检查是否有保存的阅读进度
                  const storedProgress = localStorage.getItem(`${currentBook}-progress`);
                  let startLocation = 0;

                  if (storedProgress) {
                    try {
                      startLocation = parseInt(storedProgress, 10);
                    } catch (e) {
                      // 解析失败，使用默认值0
                    }
                  }

                  // 初始化显示
                  updatePages(startLocation);

                  // 移除了重复的滚轮事件监听器设置，改为在rendered事件中添加
                }).catch(error => {
                  console.error('位置信息处理错误:', error);
                });

                // 添加键盘事件处理
                rendition.on('keydown', function(e) {
                  handleKeyNavigation(e.key);
                });

                // 统一的键盘导航处理函数
                function handleKeyNavigation(key) {
                  if(key == "ArrowLeft") {
                    navigatePrev();
                  }
                  if(key == "ArrowRight") {
                    navigateNext();
                  }
                }

                // 设置iframe的sandbox属性，允许脚本执行
                setTimeout(function() {
                  try {
                    const iframe = document.querySelector('#epub-container iframe');
                    if (iframe) {
                      iframe.sandbox = 'allow-same-origin allow-scripts';
                    }
                  } catch (e) {
                    console.error('设置iframe sandbox时出错:', e);
                  }
                }, 300);

                // 检查渲染器是否正确创建
                if (!rendition) {
                  throw new Error('Failed to create rendition');
                }

                // 监听但不处理点击事件
                rendition.on('click', function(event) {
                  // 不再尝试阻止默认行为，而是使用自定义处理
                  // 这里可以添加自定义点击处理逻辑，如显示菜单等
                });

                // 添加位置变化事件监听
                rendition.on('relocated', function(location) {
                  if (location && location.start) {
                    try {
                      const locationCfi = location.start.cfi;
                      const newLocation = book.locations.locationFromCfi(locationCfi);
                      if (newLocation !== currentLocation) {
                        currentLocation = newLocation;

                        // 更新进度显示
                        window.updateProgressInfo();

                        // 保存阅读进度
                        if (currentBook) {
                          localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());
                        }
                      }
                    } catch (e) {
                      // 更新位置时出错，忽略
                    }
                  }
                });

                // 添加内容加载事件监听器
                rendition.on('rendered', function(section) {
                  // 内容渲染后，添加滚轮事件监听器到新的内容
                  setTimeout(function() {
                    try {
                      // 查找iframe
                      const container = document.getElementById('epub-container');
                      if (!container) return;

                      const iframe = container.querySelector('iframe');
                      if (!iframe) return;

                      // 确保iframe已加载
                      if (!iframe.contentDocument && !iframe.contentWindow) return;

                      // 访问iframe的内容文档
                      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                      if (!iframeDoc) return;

                      // 设置sandbox属性
                      iframe.sandbox = 'allow-same-origin allow-scripts';

                      // 为iframe内部添加拖放事件处理
                      // 阻止默认行为，防止触发浏览器的另存为对话框
                      iframeDoc.addEventListener('dragover', function(e) {
                        e.preventDefault();

                        // 显示拖放区域
                        if (dropArea && dropArea.classList.contains('hidden')) {
                          dropArea.classList.remove('hidden');
                        }
                      });

                      // 处理iframe内部的文件拖放
                      iframeDoc.addEventListener('drop', function(e) {
                        e.preventDefault();

                        try {
                          // 获取拖放的文件并处理
                          const file = e.dataTransfer.files[0];
                          if (file && file.name.toLowerCase().endsWith('.epub')) {
                            // 使用setTimeout延迟执行，给浏览器时间处理UI更新
                            setTimeout(function() {
                              try {
                                // 处理新文件
                                handleFile(file);
                              } catch (error) {
                                console.error('处理文件时出错:', error);
                              }
                            }, 100);
                          }
                        } catch (error) {
                          console.error('处理拖放事件时出错:', error);
                        }
                      });

                      // 创建滚轮事件监听器
                      const wheelListener = function(event) {
                        // 不再尝试阻止默认行为，而是直接处理滚动

                        // 设置滚动阈值和冷却时间
                        const now = Date.now();
                        if (now - (window.lastWheelTime || 0) < 50) return;
                        window.lastWheelTime = now;

                        // 根据滚动方向导航
                        if (event.deltaY > 2) {
                          // 向下滚动，前进到下一页
                          window.navigateNext();
                        } else if (event.deltaY < -2) {
                          // 向上滚动，后退到上一页
                          window.navigatePrev();
                        }
                      };

                      // 添加监听器，使用passive: true以避免警告
                      iframeDoc.addEventListener('wheel', wheelListener, { passive: true });
                    } catch (e) {
                      console.error('添加滚轮事件监听器时出错:', e);
                    }
                  }, 200);
                });

                // 不需要在这里显示书籍，因为我们会在生成位置信息后调用updatePages(0)
              })
              .then(function() {
                // 加载元数据
                return book.loaded.metadata;
              })
              .then(function(metadata) {
                // 元数据加载完成
              })
              .catch(function(error) {
                alert('Error loading EPUB: ' + error.message);
              });
            };

            reader.onerror = function(error) {
              alert('Error reading file: ' + error);
            };

            // 开始读取文件
            reader.readAsArrayBuffer(file);
          } catch (error) {
            alert('Critical error initializing ePub reader: ' + error.message);
          }

          // 加载笔记
          if (currentNotes[currentBook]) {
            notesTextarea.value = currentNotes[currentBook];
          } else {
            notesTextarea.value = '';
          }

          // 设置键盘导航
          document.addEventListener('keydown', handleKeyPress);

          // 添加窗口大小调整事件监听器
          window.addEventListener('resize', handleResize);

        } catch (error) {
          console.error('Error in handleFile:', error);
          alert('Error loading EPUB: ' + error.message);
        }
      }

      // 处理键盘导航
      function handleKeyPress(event) {
        if (!book || !rendition) return;

        // 检查笔记区域是否处于活动状态
        if (isNotesActive) return;

        // 检查是否有其他文本输入元素处于焦点状态
        const activeElement = document.activeElement;
        const isInputActive = activeElement.tagName === 'INPUT' ||
                             activeElement.tagName === 'TEXTAREA' ||
                             activeElement.isContentEditable;

        // 如果有输入元素处于焦点状态，不处理键盘导航
        if (isInputActive) return;

        // 只处理箭头键，不阻止默认行为
        if (event.key === 'ArrowLeft') {
          window.navigatePrev();
        } else if (event.key === 'ArrowRight') {
          window.navigateNext();
        }
      }

      // 导航到上一页 - 使用ePub.js内置方法
      function navigatePrev() {
        if (!book || !rendition) return;

        // 使用rendition的prev方法导航到上一页
        rendition.prev().then(function() {
          // 导航成功后更新当前位置
          setTimeout(() => {
            try {
              const location = rendition.location;
              if (location && location.start) {
                const locationCfi = location.start.cfi;
                const newLocation = book.locations.locationFromCfi(locationCfi);
                currentLocation = newLocation;

                // 更新进度显示
                window.updateProgressInfo();

                // 保存阅读进度
                if (currentBook) {
                  localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());
                }
              }
            } catch (e) {
              console.error('更新位置时出错:', e);
            }
          }, 100);
        }).catch(function() {
          // 已经是第一页
        });
      }

      // 导航到下一页 - 使用ePub.js内置方法
      function navigateNext() {
        if (!book || !rendition) return;

        // 使用rendition的next方法导航到下一页
        rendition.next().then(function() {
          // 导航成功后更新当前位置
          setTimeout(() => {
            try {
              const location = rendition.location;
              if (location && location.start) {
                const locationCfi = location.start.cfi;
                const newLocation = book.locations.locationFromCfi(locationCfi);
                currentLocation = newLocation;

                // 更新进度显示
                window.updateProgressInfo();

                // 保存阅读进度
                if (currentBook) {
                  localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());
                }
              }
            } catch (e) {
              console.error('更新位置时出错:', e);
            }
          }, 100);
        }).catch(function() {
          // 已经是最后一页
        });
      }

      // 将导航函数添加到window对象，使其在所有作用域中可用
      window.navigatePrev = navigatePrev;
      window.navigateNext = navigateNext;

      // 处理窗口大小调整
      function handleResize() {
        if (!book || !rendition) {
          return;
        }

        // 使用节流（Throttling）技术，确保函数在指定时间间隔内最多执行一次
        const now = Date.now();

        // 如果是第一次调用，或者距离上次执行已经超过了节流时间间隔
        if (!window.lastResizeTime || now - window.lastResizeTime >= 50) { // 50ms的节流间隔
          window.lastResizeTime = now;

          // 获取新的容器尺寸
          const container = document.getElementById('epub-container');
          const newWidth = container.clientWidth;
          const newHeight = container.clientHeight;

          // 获取当前位置信息，用于调整后恢复
          try {
            // 直接获取当前位置，不使用Promise
            const location = rendition.location;
            if (location && location.start) {
              const currentCfi = location.start.cfi;

              // 调整渲染器尺寸
              rendition.resize(newWidth, newHeight);

              // 使用当前CFI重新渲染
              rendition.display(currentCfi);
            } else {
              // 使用保存的位置索引
              const cfi = book.locations.cfiFromLocation(currentLocation);
              rendition.resize(newWidth, newHeight);
              rendition.display(cfi);
            }
          } catch (error) {
            // 如果出错，使用保存的位置索引
            const cfi = book.locations.cfiFromLocation(currentLocation);
            rendition.resize(newWidth, newHeight);
            rendition.display(cfi);
          }
        }

        // 在拖动结束后进行一次完整渲染
        // 这是为了确保在拖动结束后内容完全正确
        if (window.finalResizeTimer) {
          clearTimeout(window.finalResizeTimer);
        }
        window.finalResizeTimer = setTimeout(function() {
          const container = document.getElementById('epub-container');
          const newWidth = container.clientWidth;
          const newHeight = container.clientHeight;

          try {
            const location = rendition.location;
            if (location && location.start) {
              const currentCfi = location.start.cfi;
              rendition.resize(newWidth, newHeight);
              rendition.display(currentCfi);
            }
          } catch (error) {
            // 忽略错误
          }
        }, 300); // 拖动结束后300ms进行最终渲染
      }
    });
  </script>
</body>
</html>
