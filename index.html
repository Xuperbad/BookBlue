<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookBlue</title>
  <!-- æ·»åŠ å…¨å±€å˜é‡æ¥è·Ÿè¸ªåº“åŠ è½½çŠ¶æ€ -->
  <script>
    window.librariesReady = false;
    window.librariesLoading = true;
  </script>

  <!-- å¼•å…¥JSZipåº“ - ePub.jsçš„ä¾èµ– -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- å¼•å…¥ePub.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- åº“åŠ è½½ç®¡ç† -->
  <script>
    // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
    function checkLibraries() {
      const jszipLoaded = typeof JSZip !== 'undefined';
      const epubLoaded = typeof ePub !== 'undefined';

      if (jszipLoaded && epubLoaded) {

        window.librariesReady = true;
        window.librariesLoading = false;

        // æ›´æ–°UIçŠ¶æ€
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }

        const dropArea = document.getElementById('drop-area');
        if (dropArea) {
          dropArea.classList.remove('disabled');
          const loadingText = dropArea.querySelector('.loading-text');
          if (loadingText) {
            loadingText.style.display = 'none';
          }
        }

        return true;
      }

      return false;
    }

    // å°è¯•åŠ è½½å¤‡ç”¨åº“æº
    function loadAlternateLibraries() {
      if (typeof JSZip === 'undefined') {
        var jszipScript = document.createElement('script');
        jszipScript.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
        jszipScript.onload = function() {
          checkLibraries();
        };
        document.head.appendChild(jszipScript);
      }

      if (typeof ePub === 'undefined') {
        var epubScript = document.createElement('script');
        epubScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js';
        epubScript.onload = function() {
          checkLibraries();
        };
        document.head.appendChild(epubScript);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥åº“
    window.addEventListener('load', function() {
      if (!checkLibraries()) {
        loadAlternateLibraries();

        // 5ç§’åå†æ¬¡æ£€æŸ¥
        setTimeout(function() {
          if (!window.librariesReady) {
            console.error('Failed to load libraries after timeout');
            alert('Failed to load required libraries. Please check your internet connection and try again.');
          }
        }, 5000);
      }
    });
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Serif', Georgia, serif;
      background-color: #f5f2e9;
      height: 100vh;
      overflow: hidden;
    }

    /* Dropbox æˆæƒæŒ‰é’®æ ·å¼ */
    #dropbox-auth-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      padding: 5px 10px;
      background-color: #0061fe;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }



    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    .reader-area {
      flex: 1;
      height: 100%;
      position: relative;
      background-color: #fff;
      overflow: hidden;
      cursor: default; /* ä½¿ç”¨é»˜è®¤å…‰æ ‡ï¼Œä¸æ˜¾ç¤ºæ–‡æœ¬é€‰æ‹©å…‰æ ‡ */
    }

    .notes-area {
      width: 30px; /* é»˜è®¤æ”¶èµ·çŠ¶æ€çš„å®½åº¦ */
      background-color: #f5f2e9;
      height: 100%;
      position: relative;
      transition: width 0.3s ease;
      overflow: hidden;
      box-shadow: -1px 0 3px rgba(0, 0, 0, 0.05);
    }

    .notes-area.expanded {
      width: 350px; /* å±•å¼€çŠ¶æ€çš„å®½åº¦ */
    }

    .notes-toggle {
      position: absolute;
      left: 0;
      top: 0;
      width: 30px;
      height: 100%;
      background-color: #f5f2e9;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .notes-toggle:hover {
      background-color: #ebe5d6;
    }

    .notes-toggle::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: 2px;
      background-color: #4a4238;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .notes-toggle:hover::after {
      opacity: 0.15;
    }

    .notes-toggle .icon {
      font-size: 16px;
      color: #8a7a6a;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.7;
      transition: opacity 0.2s ease, color 0.2s ease;
    }

    .notes-toggle:hover .icon {
      opacity: 1;
      color: #4a4238;
    }

    .notes-content {
      position: absolute;
      left: 30px;
      top: 0;
      width: calc(100% - 30px);
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s;
    }

    .notes-area.expanded .notes-content {
      opacity: 1;
      visibility: visible;
    }

    #epub-container {
      width: 100%;
      height: calc(100% - 30px); /* å‡å°‘é«˜åº¦ï¼Œä¸ºé¡µç ç•™å‡ºç©ºé—´ */
      position: relative;
      overflow: hidden;
    }

    .drop-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.9);
      border: 3px dashed #ccc;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .drop-area.hidden {
      display: none;
    }

    .drop-area.disabled {
      opacity: 0.7;
      pointer-events: none;
      border-color: #999;
    }

    .loading-indicator {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4a4238;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .loading-indicator::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    .loading-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a4238;
      font-size: 1.2rem;
      z-index: 2;
    }

    /* é¡µç æ˜¾ç¤º - æç®€é£æ ¼ï¼Œåªæœ‰æ•°å­— */
    .page-counter {
      position: absolute;
      bottom: 8px;
      right: 15px;
      font-size: 14px;
      color: #4a4238;
      z-index: 10;
      user-select: none;
    }

    .plus-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #4a4238;
      color: white;
      margin: 0 auto;
    }

    .plus-icon {
      font-size: 3rem;
      line-height: 1;
      display: block;
    }

    #file-input {
      display: none;
    }

    #select-file-btn {
      padding: 0.7rem 1.2rem;
      background-color: #4a4238;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #select-file-btn:hover {
      background-color: #5d5347;
    }

    #notes {
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      resize: none;
      font-family: inherit;
      background-color: transparent;
      line-height: 1.6;
      border: none;
      outline: none;
      color: #4a4238;
      box-sizing: border-box;
    }

    /* æç®€ç•Œé¢ï¼Œç§»é™¤äº†é¡µé¢ä¿¡æ¯æ ·å¼ */

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .notes-area {
        width: 100%;
        height: 200px;
      }
    }

    /* é¡¶éƒ¨æŠ½å±‰æ ·å¼ */
    .drawer-trigger {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(74, 66, 56, 0.1);
      z-index: 1000;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .drawer-trigger:hover {
      background-color: rgba(74, 66, 56, 0.2);
    }

    .trigger-indicator {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background-color: rgba(74, 66, 56, 0.5);
      border-radius: 0 0 4px 4px;
      transition: all 0.3s ease;
    }

    .drawer-trigger:hover .trigger-indicator {
      background-color: rgba(74, 66, 56, 0.8);
      height: 6px;
    }

    .top-drawer {
      position: fixed;
      top: -240px; /* åˆå§‹çŠ¶æ€éšè— - å¢åŠ åˆ°åŸæ¥çš„ä¸‰å€ */
      left: 0;
      width: 100%;
      height: 240px; /* å›ºå®šé«˜åº¦ - å¢åŠ åˆ°åŸæ¥çš„ä¸‰å€ */
      background-color: rgba(74, 66, 56, 0.9);
      z-index: 999;
      transition: top 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(5px);
    }

    .top-drawer.open {
      top: 0;
    }

    .drawer-content {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    /* Dropbox è¿æ¥å®¹å™¨ */
    .dropbox-connect-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      padding: 0 20px;
    }

    .dropbox-auth-button {
      background-color: #0061fe;
      border: none;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .dropbox-auth-button:hover {
      background-color: #0052d9;
    }

    .button-icon {
      margin-right: 8px;
      font-size: 18px;
    }

    .connect-description {
      margin-top: 8px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    /* Dropbox ä¹¦ç±å®¹å™¨ */
    .dropbox-books-container {
      display: flex;
      align-items: center;
      height: 100%;
      width: 100%;
      padding: 0 20px;
      overflow-x: auto; /* åªå…è®¸æ¨ªå‘æ»šåŠ¨ */
      overflow-y: hidden; /* ç¦æ­¢çºµå‘æ»šåŠ¨ */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
      white-space: nowrap;
      user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹©ï¼Œä¾¿äºæ‹–åŠ¨ */
    }

    /* éšè— WebKit æ»šåŠ¨æ¡ */
    .dropbox-books-container::-webkit-scrollbar {
      display: none;
    }

    /* ç§»é™¤äº†æ»šåŠ¨æ¡æ ·å¼ */

    /* ä¹¦ç±ç½‘æ ¼ */
    .books-grid {
      display: flex;
      gap: 15px;
      align-items: center;
      height: 100%;
      flex-grow: 1;
    }

    .book-card {
      width: 140px; /* å¢åŠ å®½åº¦ä»¥æ›´å¥½åœ°æ˜¾ç¤ºå°é¢ */
      height: 180px; /* å¢åŠ é«˜åº¦ä»¥æ›´å¥½åœ°æ˜¾ç¤ºå°é¢ */
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      margin-right: 15px; /* å¢åŠ é—´è· */
      margin-top: 15px; /* å¢åŠ é¡¶éƒ¨é—´è· */
      margin-bottom: 15px; /* å¢åŠ åº•éƒ¨é—´è· */
    }

    .book-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .book-cover {
      height: 100%;
      background-color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4a4238;
      font-size: 24px; /* é¦–å­—æ¯æ˜¾ç¤ºæ—¶çš„å­—ä½“å¤§å° */
      position: relative;
      overflow: hidden;
      border-radius: 4px; /* åœ†è§’è¾¹æ¡† */
    }

    /* å°é¢åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
    .cover-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.1);
      color: #4a4238;
      font-size: 14px;
    }

    /* å°é¢åŠ è½½æŒ‡ç¤ºå™¨åŠ¨ç”» */
    .cover-loading:after {
      content: '';
      animation: coverLoadingDots 1.5s infinite;
    }

    @keyframes coverLoadingDots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    .book-info {
      display: none; /* éšè—ä¹¦ç±ä¿¡æ¯ï¼Œåªåœ¨æ‚¬åœæ—¶æ˜¾ç¤º */
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 4px;
      transition: opacity 0.2s;
    }

    .book-card:hover .book-info {
      display: block;
    }

    .book-title {
      font-size: 8px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: white;
      text-align: center;
    }

    .book-meta {
      display: none; /* éšè—å…ƒæ•°æ®ï¼Œç®€åŒ–ç•Œé¢ */
    }

    .upload-area {
      width: 140px; /* ä¸ä¹¦ç±å¡ç‰‡å®½åº¦ä¸€è‡´ */
      height: 180px; /* ä¸ä¹¦ç±å¡ç‰‡é«˜åº¦ä¸€è‡´ */
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s;
      flex-shrink: 0;
      margin-right: 15px; /* å¢åŠ é—´è· */
      margin-top: 15px; /* å¢åŠ é¡¶éƒ¨é—´è· */
      margin-bottom: 15px; /* å¢åŠ åº•éƒ¨é—´è· */
    }

    .upload-area:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .upload-icon {
      font-size: 24px;
      color: white;
    }

    .upload-text {
      display: none; /* éšè—æ–‡å­—ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ */
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 600px) {
      .button-text {
        display: none; /* åœ¨å°å±å¹•ä¸Šåªæ˜¾ç¤ºå›¾æ ‡ */
      }

      .drawer-button {
        margin-right: 10px;
      }

      .top-drawer {
        height: 240px; /* ä¿æŒä¸å¤§å±å¹•ä¸€è‡´ */
        top: -240px; /* åˆå§‹çŠ¶æ€éšè— */
      }

      .book-card {
        width: 120px; /* åœ¨å°å±å¹•ä¸Šç¨å¾®å‡å°å®½åº¦ */
        height: 160px; /* åœ¨å°å±å¹•ä¸Šç¨å¾®å‡å°é«˜åº¦ */
        margin: 10px; /* å‡å°é—´è· */
      }

      .book-cover {
        font-size: 12px; /* åœ¨å°å±å¹•ä¸Šå¢åŠ å­—ä½“å¤§å° */
      }

      .upload-area {
        width: 120px; /* ä¸ä¹¦ç±å¡ç‰‡ä¿æŒä¸€è‡´ */
        height: 160px; /* ä¸ä¹¦ç±å¡ç‰‡ä¿æŒä¸€è‡´ */
        margin: 10px; /* å‡å°é—´è· */
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨æŠ½å±‰è§¦å‘åŒºåŸŸ -->
  <div id="drawer-trigger" class="drawer-trigger">
    <div class="trigger-indicator"></div>
  </div>

  <!-- é¡¶éƒ¨æŠ½å±‰å¯¼èˆª -->
  <div id="top-drawer" class="top-drawer">
    <div class="drawer-content">
      <!-- æœªè¿æ¥ Dropbox çŠ¶æ€ -->
      <div id="dropbox-connect-container" class="dropbox-connect-container">
        <button id="dropbox-auth-button" class="dropbox-auth-button">
          <span class="button-icon">ğŸ”„</span>
          <span class="button-text">è¿æ¥è‡³ Dropbox</span>
        </button>
        <div class="connect-description">è¿æ¥ Dropbox ä»¥è®¿é—®æ‚¨çš„ç”µå­ä¹¦</div>
      </div>

      <!-- å·²è¿æ¥ Dropbox çŠ¶æ€ - ä¹¦åº“å†…å®¹ -->
      <div id="dropbox-books-container" class="dropbox-books-container" style="display: none;">
        <div id="books-grid" class="books-grid">
          <!-- ä¹¦ç±å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>

        <div id="upload-area" class="upload-area">
          <div class="upload-icon">+</div>
          <input type="file" id="upload-book" accept=".epub" style="display: none;">
        </div>
      </div>
    </div>
  </div>



  <div class="container">
    <div class="reader-area">
      <!-- å•ä¸€å®¹å™¨ç”¨äºePub.jsæ¸²æŸ“ -->
      <div id="epub-container"></div>

      <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
      <div id="loading-indicator" class="loading-indicator">Loading libraries</div>

      <!-- é¡µç æ˜¾ç¤º -->
      <div id="page-counter" class="page-counter"></div>

      <!-- ç§»é™¤äº†ç´§æ€¥ç¿»é¡µæŒ‰é’® -->

      <div id="drop-area" class="drop-area disabled">
        <div class="loading-text">Loading...</div>
        <div class="plus-container">
          <span class="plus-icon">+</span>
        </div>
      </div>
      <!-- æç®€ç•Œé¢ï¼Œç§»é™¤äº†å¯¼èˆªæ¡ -->
    </div>

    <div class="notes-area" id="notes-area">
      <div class="notes-toggle" id="notes-toggle">
        <span class="icon">></span>
      </div>
      <div class="notes-content">
        <textarea id="notes" placeholder="Click here to write your notes..."></textarea>
      </div>
    </div>
  </div>

  <script>
    // é˜²æŠ–å‡½æ•° - ç”¨äºå»¶è¿Ÿæ‰§è¡Œé¢‘ç¹è§¦å‘çš„å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    // è¿›åº¦åŒæ­¥æ¨¡å— - ç”¨äºåœ¨Dropboxå’Œæœ¬åœ°ä¹‹é—´åŒæ­¥é˜…è¯»è¿›åº¦
    const progressSync = {
      // ä¿å­˜æ‰€æœ‰ä¹¦ç±çš„è¿›åº¦ä¿¡æ¯
      progressData: {},

      // å½“å‰åœ¨è¯»ä¹¦ç±
      currentReadingBook: null,

      // ä»DropboxåŠ è½½è¿›åº¦ä¿¡æ¯
      async loadFromDropbox() {
        try {
          const accessToken = localStorage.getItem('dropboxAccessToken');
          if (!accessToken) return false;

          console.log('ä»DropboxåŠ è½½é˜…è¯»è¿›åº¦...');

          // è¿›åº¦æ–‡ä»¶è·¯å¾„ - æ”¾åœ¨ä¹¦ç±ç›®å½•ä¸‹
          const progressFilePath = '/BookBlue_Progress.json';

          // å°è¯•ä»Dropboxè·å–è¿›åº¦æ–‡ä»¶
          const response = await fetch('https://content.dropboxapi.com/2/files/download', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/octet-stream',
              'Dropbox-API-Arg': JSON.stringify({ path: progressFilePath })
            }
          });

          // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„è¿›åº¦æ•°æ®å¹¶åˆå§‹åŒ–æ–‡ä»¶
          if (response.status === 409) {
            console.log('Dropboxä¸­æ²¡æœ‰è¿›åº¦æ–‡ä»¶ï¼Œåˆ›å»ºæ–°çš„è¿›åº¦æ•°æ®');
            this.progressData = {};
            this.syncFromLocal(); // ä»æœ¬åœ°åŒæ­¥ç°æœ‰æ•°æ®

            // ç«‹å³åˆ›å»ºè¿›åº¦æ–‡ä»¶
            await this.saveToDropbox();
            console.log('å·²åœ¨Dropboxä¸­åˆ›å»ºè¿›åº¦æ–‡ä»¶');

            return true;
          }

          if (!response.ok) {
            console.error('ä»DropboxåŠ è½½è¿›åº¦å¤±è´¥:', response.status);
            return false;
          }

          // è§£æè¿›åº¦æ•°æ®
          const data = await response.json();
          console.log('ä»DropboxåŠ è½½çš„è¿›åº¦æ•°æ®:', data);
          this.progressData = data;

          // è·å–å½“å‰åœ¨è¯»ä¹¦ç±
          if (data._currentBook) {
            this.currentReadingBook = data._currentBook;
            console.log('å½“å‰åœ¨è¯»ä¹¦ç±:', this.currentReadingBook);
          }

          // åŒæ­¥åˆ°localStorage
          this.syncToLocal();
          return true;
        } catch (error) {
          console.error('ä»DropboxåŠ è½½è¿›åº¦å¤±è´¥:', error);
          return false;
        }
      },

      // ä¿å­˜è¿›åº¦åˆ°Dropbox
      async saveToDropbox() {
        try {
          const accessToken = localStorage.getItem('dropboxAccessToken');
          if (!accessToken) {
            console.log('æœªè¿æ¥Dropboxï¼Œæ— æ³•ä¿å­˜è¿›åº¦');
            return false;
          }

          console.log('ä¿å­˜é˜…è¯»è¿›åº¦åˆ°Dropbox...');

          // åŒæ­¥æœ¬åœ°è¿›åº¦åˆ°å†…å­˜
          this.syncFromLocal();

          // ä¿å­˜å½“å‰åœ¨è¯»ä¹¦ç±
          if (window.currentBook) {
            this.progressData._currentBook = window.currentBook;
            this.currentReadingBook = window.currentBook;
          }

          // è¿›åº¦æ–‡ä»¶è·¯å¾„ - ä¸loadFromDropboxä¿æŒä¸€è‡´
          const progressFilePath = '/BookBlue_Progress.json';

          // å°†è¿›åº¦æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
          const progressContent = JSON.stringify(this.progressData, null, 2); // ä½¿ç”¨æ ¼å¼åŒ–çš„JSONï¼Œä¾¿äºé˜…è¯»

          console.log('å‡†å¤‡ä¿å­˜è¿›åº¦åˆ°Dropbox:', progressFilePath);
          console.log('è¿›åº¦æ•°æ®:', JSON.stringify(this.progressData));

          // ä¸Šä¼ åˆ°Dropbox
          console.log('å‘é€ä¿å­˜è¿›åº¦è¯·æ±‚...');
          const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/octet-stream',
              'Dropbox-API-Arg': JSON.stringify({
                path: progressFilePath,
                mode: 'overwrite'
              })
            },
            body: progressContent
          });

          console.log(`ä¿å­˜è¿›åº¦å“åº”çŠ¶æ€: ${response.status}`);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('ä¿å­˜è¿›åº¦åˆ°Dropboxå¤±è´¥:', response.status, errorText);
            return false;
          }

          // è§£æå“åº”
          const result = await response.json();
          console.log('æˆåŠŸä¿å­˜è¿›åº¦åˆ°Dropbox:', result);
          return true;
        } catch (error) {
          console.error('ä¿å­˜è¿›åº¦åˆ°Dropboxå¤±è´¥:', error);
          return false;
        }
      },

      // ä»localStorageåŒæ­¥åˆ°å†…å­˜
      syncFromLocal() {
        // éå†localStorageï¼Œæ‰¾å‡ºæ‰€æœ‰è¿›åº¦ä¿¡æ¯
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.endsWith('-progress')) {
            const bookName = key.replace('-progress', '');
            this.progressData[bookName] = localStorage.getItem(key);
          }
        }

        // åŒæ­¥å½“å‰åœ¨è¯»ä¹¦ç±
        if (window.currentBook) {
          this.progressData._currentBook = window.currentBook;
          this.currentReadingBook = window.currentBook;
        }
      },

      // ä»å†…å­˜åŒæ­¥åˆ°localStorage
      syncToLocal() {
        // å°†å†…å­˜ä¸­çš„è¿›åº¦ä¿¡æ¯ä¿å­˜åˆ°localStorage
        for (const bookName in this.progressData) {
          // è·³è¿‡ç‰¹æ®Šé”®
          if (bookName === '_currentBook') continue;

          localStorage.setItem(`${bookName}-progress`, this.progressData[bookName]);
        }

        // åŒæ­¥å½“å‰åœ¨è¯»ä¹¦ç±
        if (this.currentReadingBook) {
          // ä¸ç›´æ¥è®¾ç½®window.currentBookï¼Œå› ä¸ºè¿™éœ€è¦åœ¨åŠ è½½ä¹¦ç±æ—¶è®¾ç½®
          localStorage.setItem('_currentReadingBook', this.currentReadingBook);
        }
      },

      // æ›´æ–°å•æœ¬ä¹¦çš„è¿›åº¦
      updateBookProgress(bookName, progress, saveToCloud = true) {
        console.log(`æ›´æ–°ä¹¦ç±è¿›åº¦: ${bookName}, ä½ç½®: ${progress}, ä¿å­˜åˆ°äº‘ç«¯: ${saveToCloud}`);

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem(`${bookName}-progress`, progress);

        // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
        this.progressData[bookName] = progress;

        // æ›´æ–°å½“å‰åœ¨è¯»ä¹¦ç±
        this.progressData._currentBook = bookName;
        this.currentReadingBook = bookName;

        // å¦‚æœéœ€è¦ä¿å­˜åˆ°äº‘ç«¯
        if (saveToCloud) {
          // ä¿å­˜åˆ°Dropbox
          this.saveToDropbox().then(success => {
            if (success) {
              console.log('æˆåŠŸä¿å­˜è¿›åº¦åˆ°Dropbox');
            } else {
              console.warn('ä¿å­˜è¿›åº¦åˆ°Dropboxå¤±è´¥ï¼Œå°†åœ¨ç¨åé‡è¯•');
              // å¦‚æœä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨èŠ‚æµå‡½æ•°ç¨åé‡è¯•
              this.debouncedSaveToDropbox();
            }
          }).catch(error => {
            console.error('ä¿å­˜è¿›åº¦åˆ°Dropboxæ—¶å‡ºé”™:', error);
            // å‡ºé”™æ—¶ä½¿ç”¨èŠ‚æµå‡½æ•°ç¨åé‡è¯•
            this.debouncedSaveToDropbox();
          });
        }
      },

      // åŠ è½½å½“å‰åœ¨è¯»ä¹¦ç±
      async loadCurrentBook() {
        // å¦‚æœæ²¡æœ‰å½“å‰åœ¨è¯»ä¹¦ç±ï¼Œè¿”å›false
        if (!this.currentReadingBook) {
          console.log('æ²¡æœ‰å½“å‰åœ¨è¯»ä¹¦ç±');
          return false;
        }

        console.log('å°è¯•åŠ è½½å½“å‰åœ¨è¯»ä¹¦ç±:', this.currentReadingBook);

        // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥Dropbox
        const accessToken = localStorage.getItem('dropboxAccessToken');
        if (!accessToken) {
          console.log('æœªè¿æ¥Dropboxï¼Œæ— æ³•åŠ è½½ä¹¦ç±');
          return false;
        }

        // æ£€æŸ¥handleFileå‡½æ•°æ˜¯å¦å·²å®šä¹‰
        if (typeof window.handleFile !== 'function') {
          console.log('handleFileå‡½æ•°å°šæœªå®šä¹‰ï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶...');

          // ç­‰å¾…DOMContentLoadedäº‹ä»¶
          return new Promise((resolve) => {
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', async () => {
                // DOMContentLoadedäº‹ä»¶è§¦å‘åï¼ŒhandleFileå‡½æ•°åº”è¯¥å·²å®šä¹‰
                // é€’å½’è°ƒç”¨è‡ªèº«
                const result = await this.loadCurrentBook();
                resolve(result);
              });
            } else {
              // å¦‚æœæ–‡æ¡£å·²åŠ è½½å®Œæˆä½†handleFileä»æœªå®šä¹‰ï¼Œå¯èƒ½æ˜¯å…¶ä»–åŸå› 
              console.error('æ–‡æ¡£å·²åŠ è½½ä½†handleFileå‡½æ•°æœªå®šä¹‰');
              resolve(false);
            }
          });
        }

        try {
          // é¦–å…ˆå°è¯•åˆ—å‡ºæ‰€æœ‰EPUBæ–‡ä»¶ï¼Œç„¶ååœ¨æœ¬åœ°è¿›è¡ŒåŒ¹é…
          console.log('åˆ—å‡ºæ‰€æœ‰EPUBæ–‡ä»¶...');
          const listResponse = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              path: '',
              recursive: true,
              include_media_info: false,
              include_deleted: false,
              include_has_explicit_shared_members: false,
              include_mounted_folders: true,
              include_non_downloadable_files: false
            })
          });

          if (!listResponse.ok) {
            console.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥:', listResponse.status);
            return false;
          }

          const listResult = await listResponse.json();
          console.log('æ‰¾åˆ°æ–‡ä»¶æ•°é‡:', listResult.entries.length);

          // è¿‡æ»¤å‡ºæ‰€æœ‰EPUBæ–‡ä»¶
          const epubFiles = listResult.entries.filter(entry =>
            entry.name.toLowerCase().endsWith('.epub') && entry['.tag'] === 'file'
          );

          console.log('æ‰¾åˆ°EPUBæ–‡ä»¶æ•°é‡:', epubFiles.length);

          // å°è¯•æ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„ä¹¦ç±
          let exactMatch = null;
          for (const file of epubFiles) {
            if (file.name === this.currentReadingBook) {
              exactMatch = file;
              break;
            }
          }

          // å¦‚æœæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨loadBookFromDropboxåŠ è½½å®ƒ
          if (exactMatch) {
            console.log('æ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„ä¹¦ç±:', exactMatch.name);

            // ä½¿ç”¨ä¸loadBookFromDropboxç›¸åŒçš„æ–¹æ³•åŠ è½½ä¹¦ç±
            const path = exactMatch.path_lower;
            console.log(`æ­£åœ¨ä»DropboxåŠ è½½ä¹¦ç±: ${path}`);

            // ä½¿ç”¨Dropboxå®˜æ–¹æ¨èçš„æ–¹å¼å¤„ç†APIå‚æ•°
            const argObj = { path: path };
            const safeArg = httpHeaderSafeJson(argObj);

            console.log('å®‰å…¨ç¼–ç åçš„Dropbox APIå‚æ•°:', safeArg);

            // åˆ›å»ºè¯·æ±‚å¤´
            const headers = {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/octet-stream',
              'Dropbox-API-Arg': safeArg
            };

            // ä¸‹è½½æ–‡ä»¶
            const response = await fetch('https://content.dropboxapi.com/2/files/download', {
              method: 'POST',
              headers: headers
            });

            if (!response.ok) {
              console.error('ä»Dropboxä¸‹è½½ä¹¦ç±å¤±è´¥:', response.status);
              return false;
            }

            // è·å–æ–‡ä»¶å†…å®¹
            const arrayBuffer = await response.arrayBuffer();

            // è·å–æ–‡ä»¶å
            const fileName = path.split('/').pop();

            // åˆ›å»ºBlobå’ŒFileå¯¹è±¡
            const blob = new Blob([arrayBuffer], {type: 'application/epub+zip'});
            const file = new File([blob], fileName, {type: 'application/epub+zip'});

            console.log('åˆ›å»ºçš„Fileå¯¹è±¡:', file);

            // å†æ¬¡æ£€æŸ¥handleFileå‡½æ•°æ˜¯å¦å·²å®šä¹‰
            if (typeof window.handleFile !== 'function') {
              console.error('handleFileå‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•åŠ è½½ä¹¦ç±');
              return false;
            }

            // å¤„ç†æ–‡ä»¶
            window.handleFile(file);

            // å¦‚æœæœ‰ä¿å­˜çš„è¿›åº¦ï¼ŒåŠ è½½åˆ°è¯¥ä½ç½®
            if (this.progressData[fileName]) {
              const progress = parseInt(this.progressData[fileName]);
              console.log(`åŠ è½½ä¿å­˜çš„é˜…è¯»è¿›åº¦: ${progress}`);

              // ç­‰å¾…ä¹¦ç±åŠ è½½å®Œæˆåè®¾ç½®ä½ç½®
              setTimeout(() => {
                if (window.book && window.updatePages) {
                  window.updatePages(progress);
                }
              }, 1000);
            }

            return true;
          }

          // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
          console.log('æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…...');

          // ä»å½“å‰ä¹¦ç±åç§°ä¸­æå–ä¸»è¦éƒ¨åˆ†ï¼ˆå»æ‰æ‹¬å·å†…å®¹å’Œæ‰©å±•åï¼‰
          const mainBookName = this.currentReadingBook.split('(')[0].trim().replace('.epub', '');

          // å°è¯•æ‰¾åˆ°åŒ…å«ä¸»è¦ä¹¦åçš„ä¹¦ç±
          let fuzzyMatch = null;
          for (const file of epubFiles) {
            if (file.name.includes(mainBookName)) {
              fuzzyMatch = file;
              break;
            }
          }

          // å¦‚æœæ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…ï¼ŒåŠ è½½å®ƒ
          if (fuzzyMatch) {
            console.log('æ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…çš„ä¹¦ç±:', fuzzyMatch.name);
            await loadBookFromDropbox(fuzzyMatch.path_lower);
            return true;
          }

          console.log('æœªæ‰¾åˆ°ä¹¦ç±:', this.currentReadingBook);
          return false;
        } catch (error) {
          console.error('åŠ è½½å½“å‰åœ¨è¯»ä¹¦ç±å¤±è´¥:', error);
          return false;
        }
      },

      // èŠ‚æµä¿å­˜å‡½æ•°
      debouncedSaveToDropbox: null
    };

    // åˆå§‹åŒ–èŠ‚æµå‡½æ•°
    progressSync.debouncedSaveToDropbox = debounce(() => {
      progressSync.saveToDropbox();
    }, 5000); // 5ç§’å†…åªä¿å­˜ä¸€æ¬¡

    // Dropbox é…ç½®
    // æ³¨æ„ï¼šå¦‚æœæ‚¨è¦åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨ï¼Œè¯·ä¿®æ”¹ä»¥ä¸‹é…ç½®
    const dropboxConfig = {
      // æ‚¨çš„ Dropbox åº”ç”¨å¯†é’¥ (https://www.dropbox.com/developers/apps)
      clientId: '6swvs08dx2uakdi',

      // æ‚¨çš„ Dropbox åº”ç”¨å¯†é’¥å¯¹åº”çš„å¯†é’¥
      // æ³¨æ„ï¼šè¿™æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä¸åº”è¯¥ç¡¬ç¼–ç 
      clientSecret: 'bjyje0f7g4wrlg6',  // è¯·ä» Dropbox å¼€å‘è€…æ§åˆ¶å°è·å–å¹¶å¡«å†™

      // é‡å®šå‘ URI - ä½¿ç”¨å®Œæ•´çš„å½“å‰é¡µé¢ URL (åŒ…æ‹¬è·¯å¾„)
      // è¿™æ ·å¯ä»¥ç¡®ä¿ä¸ Dropbox åº”ç”¨è®¾ç½®ä¸­çš„é‡å®šå‘ URI åŒ¹é…
      get redirectUri() {
        // ä½¿ç”¨å®Œæ•´çš„å½“å‰é¡µé¢ URLï¼Œè€Œä¸ä»…ä»…æ˜¯ origin
        return window.location.href.split('?')[0].split('#')[0];
      }
    };

    // Dropbox æˆæƒå‡½æ•°
    async function handleDropboxAuth() {
      console.log('å¼€å§‹ Dropbox æˆæƒæµç¨‹...');

      // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† client_secret
      if (!dropboxConfig.clientSecret) {
        alert('è¯·å…ˆè®¾ç½® Dropbox åº”ç”¨å¯†é’¥å¯¹åº”çš„å¯†é’¥ï¼ˆclient_secretï¼‰ã€‚');
        return;
      }

      try {
        // è·å–é‡å®šå‘ URL
        const redirectUrl = dropboxConfig.redirectUri;
        console.log(`ä½¿ç”¨é‡å®šå‘ URL: ${redirectUrl}`);

        // ç”ŸæˆéšæœºçŠ¶æ€å‚æ•°ï¼Œé˜²æ­¢ CSRF æ”»å‡»
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem('dropboxAuthState', state);

        // æ„å»ºæˆæƒ URL
        const authUrl = new URL('https://www.dropbox.com/oauth2/authorize');
        authUrl.searchParams.append('client_id', dropboxConfig.clientId);
        authUrl.searchParams.append('response_type', 'code');
        authUrl.searchParams.append('redirect_uri', redirectUrl);
        authUrl.searchParams.append('state', state);
        authUrl.searchParams.append('scope', 'files.content.read files.content.write files.metadata.read');
        authUrl.searchParams.append('token_access_type', 'offline');

        // ç›´æ¥è·³è½¬åˆ°æˆæƒé¡µé¢
        const authUrlString = authUrl.toString();
        console.log(`æˆæƒ URL: ${authUrlString}`);

        // è·³è½¬åˆ° Dropbox æˆæƒé¡µé¢
        window.location.href = authUrlString;
      } catch (error) {
        console.error('ç”Ÿæˆæˆæƒ URL æ—¶å‡ºé”™:', error);
        alert('è¿æ¥ Dropbox æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚');
      }
    }

    // å¤„ç†æˆæƒé‡å®šå‘
    function handleDropboxRedirect() {
      console.log('æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰æˆæƒç ...');
      console.log('å½“å‰ URL:', window.location.href);
      console.log('ä½¿ç”¨çš„é‡å®šå‘ URI:', dropboxConfig.redirectUri);

      // æ£€æŸ¥ URL ä¸­æ˜¯å¦åŒ…å«æˆæƒç 
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      if (error) {
        console.log(`æˆæƒå¤±è´¥: ${error}`);
        if (errorDescription) {
          console.log(`é”™è¯¯æè¿°: ${errorDescription}`);
        }

        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬é‡å®šå‘ URI
        let errorMessage = `Dropbox æˆæƒå¤±è´¥: ${error}`;
        if (errorDescription) {
          errorMessage += `\né”™è¯¯æè¿°: ${errorDescription}`;
        }
        errorMessage += `\n\nè¯·ç¡®ä¿åœ¨ Dropbox å¼€å‘è€…æ§åˆ¶å°ä¸­è®¾ç½®çš„é‡å®šå‘ URI ä¸ä»¥ä¸‹å€¼åŒ¹é…:\n${dropboxConfig.redirectUri}`;

        alert(errorMessage);
        return;
      }

      // éªŒè¯çŠ¶æ€å‚æ•°
      const savedState = localStorage.getItem('dropboxAuthState');
      if (state && savedState && state !== savedState) {
        console.log('çŠ¶æ€å‚æ•°ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯ CSRF æ”»å‡»');
        alert('å®‰å…¨éªŒè¯å¤±è´¥ï¼šçŠ¶æ€å‚æ•°ä¸åŒ¹é…');
        return;
      }

      if (authCode) {
        console.log('ä» URL ä¸­è·å–åˆ°æˆæƒç ');
        console.log(`æˆæƒç : ${authCode.substring(0, 5)}...${authCode.substring(authCode.length - 5)}`);

        // æ¸…é™¤ URL ä¸­çš„æˆæƒç 
        window.history.replaceState(null, null, window.location.pathname);

        // ä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
        exchangeCodeForToken(authCode);

        // æ¸…é™¤çŠ¶æ€å‚æ•°
        localStorage.removeItem('dropboxAuthState');
      }
    }

    // ä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
    async function exchangeCodeForToken(code) {
      console.log('ä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ...');

      try {
        // å‡†å¤‡è¯·æ±‚æ•°æ®
        const data = new URLSearchParams();
        data.append('code', code);
        data.append('grant_type', 'authorization_code');
        data.append('client_id', dropboxConfig.clientId);
        data.append('redirect_uri', dropboxConfig.redirectUri);

        // æ·»åŠ  client_secret å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
        if (dropboxConfig.clientSecret) {
          data.append('client_secret', dropboxConfig.clientSecret);
        } else {
          console.warn('è­¦å‘Š: ç¼ºå°‘ client_secretï¼Œè¿™å¯èƒ½å¯¼è‡´ä»¤ç‰Œè¯·æ±‚å¤±è´¥');
          alert('è¯·åœ¨ä»£ç ä¸­è®¾ç½® Dropbox åº”ç”¨å¯†é’¥å¯¹åº”çš„å¯†é’¥ï¼ˆclient_secretï¼‰ã€‚\n\næ‚¨å¯ä»¥åœ¨ Dropbox å¼€å‘è€…æ§åˆ¶å°ä¸­æ‰¾åˆ°å®ƒã€‚');
          return;
        }

        console.log('å‘é€ä»¤ç‰Œè¯·æ±‚...');

        // å‘é€è¯·æ±‚
        const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: data
        });

        console.log(`ä»¤ç‰Œå“åº”çŠ¶æ€: ${response.status}`);

        if (!response.ok) {
          const errorText = await response.text();
          console.log(`è·å–ä»¤ç‰Œå¤±è´¥: ${errorText}`);
          console.log('è¯·æ±‚å‚æ•°:', {
            code: code,
            grant_type: 'authorization_code',
            client_id: dropboxConfig.clientId,
            redirect_uri: dropboxConfig.redirectUri
          });

          // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
          let errorMessage = `è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥ (${response.status}): ${errorText}\n\n`;
          errorMessage += 'å¯èƒ½çš„åŸå› :\n';
          errorMessage += '1. é‡å®šå‘ URI ä¸åŒ¹é… - è¯·ç¡®ä¿åœ¨ Dropbox å¼€å‘è€…æ§åˆ¶å°ä¸­è®¾ç½®çš„é‡å®šå‘ URI ä¸ä»¥ä¸‹å€¼å®Œå…¨åŒ¹é…:\n';
          errorMessage += `   ${dropboxConfig.redirectUri}\n`;
          errorMessage += '2. client_id æˆ– client_secret ä¸æ­£ç¡®\n';
          errorMessage += '3. æˆæƒç å·²è¿‡æœŸæˆ–å·²è¢«ä½¿ç”¨\n\n';
          errorMessage += 'è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚';

          alert(errorMessage);
          return;
        }

        // è§£æå“åº”
        const result = await response.json();
        console.log('æˆåŠŸè·å–è®¿é—®ä»¤ç‰Œ');

        const accessToken = result.access_token;
        const refreshToken = result.refresh_token;
        const expiresIn = result.expires_in;
        const tokenType = result.token_type;

        console.log(`è®¿é—®ä»¤ç‰Œ: ${accessToken.substring(0, 5)}...${accessToken.substring(accessToken.length - 5)}`);
        if (refreshToken) {
          console.log(`åˆ·æ–°ä»¤ç‰Œ: ${refreshToken.substring(0, 5)}...${refreshToken.substring(refreshToken.length - 5)}`);
        }
        console.log(`è¿‡æœŸæ—¶é—´: ${expiresIn}ç§’`);
        console.log(`ä»¤ç‰Œç±»å‹: ${tokenType}`);

        // ä¿å­˜ä»¤ç‰Œ
        localStorage.setItem('dropboxAccessToken', accessToken);
        if (refreshToken) {
          localStorage.setItem('dropboxRefreshToken', refreshToken);
        }

        // ä¿å­˜ä»¤ç‰Œè·å–æ—¶é—´å’Œè¿‡æœŸæ—¶é—´
        const now = new Date().getTime();
        localStorage.setItem('dropboxTokenTime', now);
        if (expiresIn) {
          const expiryTime = now + (parseInt(expiresIn) * 1000);
          localStorage.setItem('dropboxTokenExpiry', expiryTime);
          console.log(`ä»¤ç‰Œå°†åœ¨ ${new Date(expiryTime).toLocaleString()} è¿‡æœŸ`);
        }

        // æ›´æ–° UI çŠ¶æ€
        updateDropboxAuthUI(true);

        // å°è¯•åŠ è½½é˜…è¯»è¿›åº¦å’Œä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±
        try {
          console.log('æˆæƒæˆåŠŸåå°è¯•ä»DropboxåŠ è½½é˜…è¯»è¿›åº¦...');

          // åŠ è½½é˜…è¯»è¿›åº¦
          await progressSync.loadFromDropbox();

          // å°è¯•åŠ è½½ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±
          const bookLoaded = await progressSync.loadCurrentBook();

          if (bookLoaded) {
            console.log('æˆåŠŸåŠ è½½ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±');
            // ä¸æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œå› ä¸ºå·²ç»åŠ è½½äº†ä¹¦ç±
          } else {
            console.log('æ²¡æœ‰æ‰¾åˆ°ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±æˆ–åŠ è½½å¤±è´¥');
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('æˆåŠŸè¿æ¥åˆ° Dropboxï¼');
          }
        } catch (error) {
          console.error('åŠ è½½é˜…è¯»è¿›åº¦æˆ–ä¹¦ç±æ—¶å‡ºé”™:', error);
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          alert('æˆåŠŸè¿æ¥åˆ° Dropboxï¼');
        }

      } catch (error) {
        console.error('äº¤æ¢ä»¤ç‰Œæ—¶å‡ºé”™:', error);
        alert(`è·å–è®¿é—®ä»¤ç‰Œæ—¶å‡ºé”™: ${error.message}`);
      }
    }

    // æ›´æ–° Dropbox æˆæƒ UI
    function updateDropboxAuthUI(isAuthorized) {
      const connectContainer = document.getElementById('dropbox-connect-container');
      const booksContainer = document.getElementById('dropbox-books-container');

      if (isAuthorized) {
        // å·²æˆæƒçŠ¶æ€ï¼šæ˜¾ç¤ºä¹¦ç±å®¹å™¨ï¼Œéšè—è¿æ¥æŒ‰é’®
        if (connectContainer) connectContainer.style.display = 'none';
        if (booksContainer) booksContainer.style.display = 'flex';

        // åŠ è½½ Dropbox ä¸­çš„ä¹¦ç±
        loadDropboxBooks();
      } else {
        // æœªæˆæƒçŠ¶æ€ï¼šæ˜¾ç¤ºè¿æ¥æŒ‰é’®ï¼Œéšè—ä¹¦ç±å®¹å™¨
        if (connectContainer) connectContainer.style.display = 'flex';
        if (booksContainer) booksContainer.style.display = 'none';
      }
    }

    // ä» Dropbox åŠ è½½ä¹¦ç±
    async function loadDropboxBooks() {
      try {
        const accessToken = localStorage.getItem('dropboxAccessToken');
        if (!accessToken) {
          console.error('æœªæ‰¾åˆ° Dropbox è®¿é—®ä»¤ç‰Œ');
          return;
        }

        console.log('æ­£åœ¨ä» Dropbox åŠ è½½ä¹¦ç±...');

        // æ„å»ºè¯·æ±‚ä½“
        const requestBody = {
          path: '', // æ ¹ç›®å½•
          recursive: true,
          include_media_info: false,
          include_deleted: false,
          include_has_explicit_shared_members: false,
          include_mounted_folders: true,
          include_non_downloadable_files: false
        };

        console.log('åˆ—å‡ºæ–‡ä»¶å¤¹è¯·æ±‚ä½“:', JSON.stringify(requestBody));

        // åˆ—å‡º Dropbox ä¸­çš„æ–‡ä»¶
        const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          // å°è¯•è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMessage = `Dropbox API é”™è¯¯: ${response.status}`;
          try {
            const errorData = await response.text();
            console.error('åˆ—å‡ºæ–‡ä»¶å¤¹é”™è¯¯è¯¦æƒ…:', errorData);
            errorMessage += ` - ${errorData}`;
          } catch (e) {
            console.error('æ— æ³•è§£æåˆ—è¡¨é”™è¯¯è¯¦æƒ…:', e);
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        // è¿‡æ»¤å‡º EPUB æ–‡ä»¶
        const epubFiles = data.entries.filter(entry =>
          entry.name.toLowerCase().endsWith('.epub') && entry['.tag'] === 'file'
        );

        console.log(`æ‰¾åˆ° ${epubFiles.length} æœ¬ EPUB ä¹¦ç±`);

        // æ˜¾ç¤ºä¹¦ç±
        displayDropboxBooks(epubFiles);
      } catch (error) {
        console.error('åŠ è½½ Dropbox ä¹¦ç±å¤±è´¥:', error);
        alert('æ— æ³•åŠ è½½ Dropbox ä¸­çš„ä¹¦ç±ï¼Œè¯·é‡è¯•ã€‚');
      }
    }

    // æ˜¾ç¤º Dropbox ä¸­çš„ä¹¦ç±
    function displayDropboxBooks(books) {
      const booksGrid = document.getElementById('books-grid');
      if (!booksGrid) return;

      // æ¸…ç©ºç°æœ‰å†…å®¹
      booksGrid.innerHTML = '';

      if (books.length === 0) {
        // æ²¡æœ‰ä¹¦ç±æ—¶æ˜¾ç¤ºæç¤º
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = 'æ²¡æœ‰æ‰¾åˆ° EPUB ä¹¦ç±ï¼Œè¯·ç‚¹å‡» + æ·»åŠ ';
        emptyMessage.style.color = 'rgba(255, 255, 255, 0.7)';
        emptyMessage.style.padding = '0 20px';
        booksGrid.appendChild(emptyMessage);
        return;
      }

      // æ·»åŠ æ¯æœ¬ä¹¦
      books.forEach(book => {
        const bookCard = createBookCard(book);
        booksGrid.appendChild(bookCard);
      });
    }

    // æ ¹æ®Dropbox APIæ–‡æ¡£ï¼Œå¤„ç†HTTPå¤´ä¸­çš„JSON
    function httpHeaderSafeJson(obj) {
      return JSON.stringify(obj).replace(/[\u007f-\uffff]/g, function(c) {
        return '\\u' + ('000' + c.charCodeAt(0).toString(16)).slice(-4);
      });
    }

    // å¤„ç†å¯èƒ½åŒ…å«éASCIIå­—ç¬¦çš„è·¯å¾„
    function sanitizeDropboxPath(path) {
      // æ£€æŸ¥è·¯å¾„æ˜¯å¦åŒ…å«éASCIIå­—ç¬¦
      const hasNonAscii = /[^\x00-\x7F]/.test(path);

      if (hasNonAscii) {
        console.log(`è·¯å¾„åŒ…å«éASCIIå­—ç¬¦: ${path}`);
        console.warn('æ–‡ä»¶è·¯å¾„åŒ…å«éASCIIå­—ç¬¦ï¼Œä½¿ç”¨Dropboxå®˜æ–¹ç¼–ç æ–¹å¼å¤„ç†');
      }

      // ä¸éœ€è¦ä¿®æ”¹è·¯å¾„æœ¬èº«ï¼Œè€Œæ˜¯åœ¨æ„å»ºAPIå‚æ•°æ—¶ä½¿ç”¨httpHeaderSafeJsonå‡½æ•°
      return path;
    }

    // å°é¢ç¼“å­˜ç®¡ç†
    const coverCache = {
      async get(bookId) {
        try {
          return localStorage.getItem(`book-cover-${bookId}`);
        } catch (e) {
          console.error('è·å–å°é¢ç¼“å­˜å¤±è´¥:', e);
          return null;
        }
      },

      async set(bookId, coverUrl) {
        try {
          localStorage.setItem(`book-cover-${bookId}`, coverUrl);
        } catch (e) {
          console.error('ä¿å­˜å°é¢ç¼“å­˜å¤±è´¥:', e);
        }
      }
    };

    // ä»EPUBæ–‡ä»¶æå–å°é¢
    async function extractCoverFromEpub(file) {
      return new Promise((resolve, reject) => {
        try {
          console.log('å¼€å§‹æå–å°é¢:', file.name);

          // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¼“å­˜çš„å°é¢
          const bookId = file.name;
          coverCache.get(bookId).then(cachedCover => {
            if (cachedCover) {
              console.log('ä½¿ç”¨ç¼“å­˜çš„å°é¢:', bookId);
              resolve(cachedCover);
              return;
            }

            // æ²¡æœ‰ç¼“å­˜ï¼Œéœ€è¦æå–å°é¢
            console.log('æ²¡æœ‰ç¼“å­˜çš„å°é¢ï¼Œå¼€å§‹æå–');

            // åˆ›å»ºä¸´æ—¶çš„Bookå¯¹è±¡
            const book = ePub();

            // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
              const arrayBuffer = e.target.result;

              // æ‰“å¼€EPUBæ–‡ä»¶
              book.open(arrayBuffer)
                .then(() => {
                  // å°è¯•è·å–å°é¢
                  return book.loaded.cover;
                })
                .then(coverPath => {
                  if (!coverPath) {
                    console.log('EPUBæ–‡ä»¶æ²¡æœ‰å°é¢:', file.name);
                    resolve(null);
                    return;
                  }

                  console.log('æ‰¾åˆ°å°é¢è·¯å¾„:', coverPath);

                  // è·å–å°é¢URL
                  return book.archive.createUrl(coverPath, { base64: true });
                })
                .then(coverUrl => {
                  if (coverUrl) {
                    console.log('æˆåŠŸæå–å°é¢URL');

                    // ç¼“å­˜å°é¢URL
                    coverCache.set(bookId, coverUrl);

                    resolve(coverUrl);
                  } else {
                    console.log('æ— æ³•åˆ›å»ºå°é¢URL');
                    resolve(null);
                  }
                })
                .catch(error => {
                  console.error('æå–å°é¢æ—¶å‡ºé”™:', error);
                  resolve(null);
                });
            };

            reader.onerror = function(error) {
              console.error('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™:', error);
              resolve(null);
            };

            reader.readAsArrayBuffer(file);
          });
        } catch (error) {
          console.error('æå–å°é¢è¿‡ç¨‹ä¸­å‡ºé”™:', error);
          resolve(null);
        }
      });
    }

    // ä»Dropboxä¸‹è½½æ–‡ä»¶å¹¶æå–å°é¢
    async function extractCoverFromDropbox(path) {
      try {
        const accessToken = localStorage.getItem('dropboxAccessToken');
        if (!accessToken) {
          console.error('æœªæ‰¾åˆ°Dropboxè®¿é—®ä»¤ç‰Œ');
          return null;
        }

        // æ£€æŸ¥ç¼“å­˜
        const bookId = path.split('/').pop();
        const cachedCover = await coverCache.get(bookId);
        if (cachedCover) {
          console.log('ä½¿ç”¨ç¼“å­˜çš„Dropboxå°é¢:', bookId);
          return cachedCover;
        }

        console.log('ä»Dropboxä¸‹è½½æ–‡ä»¶ä»¥æå–å°é¢:', path);

        // ä½¿ç”¨Dropbox APIä¸‹è½½æ–‡ä»¶
        const argObj = { path: path };
        const safeArg = httpHeaderSafeJson(argObj);

        const response = await fetch('https://content.dropboxapi.com/2/files/download', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': safeArg
          }
        });

        if (!response.ok) {
          console.error('ä»Dropboxä¸‹è½½æ–‡ä»¶å¤±è´¥:', response.status);
          return null;
        }

        // è·å–æ–‡ä»¶å†…å®¹
        const arrayBuffer = await response.arrayBuffer();

        // è·å–æ–‡ä»¶å
        const fileName = path.split('/').pop();

        // åˆ›å»ºFileå¯¹è±¡
        const blob = new Blob([arrayBuffer], {type: 'application/epub+zip'});
        const file = new File([blob], fileName, {type: 'application/epub+zip'});

        // æå–å°é¢
        return await extractCoverFromEpub(file);
      } catch (error) {
        console.error('ä»Dropboxæå–å°é¢å¤±è´¥:', error);
        return null;
      }
    }

    // åˆ›å»ºä¹¦ç±å¡ç‰‡
    function createBookCard(book) {
      const card = document.createElement('div');
      card.className = 'book-card';

      // åˆ›å»ºå°é¢å®¹å™¨
      const cover = document.createElement('div');
      cover.className = 'book-cover';

      // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
      const loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'cover-loading';
      loadingIndicator.textContent = '...';
      cover.appendChild(loadingIndicator);

      // è·å–ä¹¦åï¼ˆå»æ‰.epubåç¼€ï¼‰
      const bookName = book.name.replace('.epub', '');

      // åˆ›å»ºä¿¡æ¯
      const info = document.createElement('div');
      info.className = 'book-info';

      const title = document.createElement('div');
      title.className = 'book-title';
      title.textContent = bookName;

      // æ£€æŸ¥æ˜¯å¦åŒ…å«éASCIIå­—ç¬¦
      if (/[^\x00-\x7F]/.test(book.name)) {
        // æ·»åŠ è­¦å‘Šæ ‡è®°
        title.style.color = '#ffcc00';
        title.title = 'æ­¤æ–‡ä»¶ååŒ…å«ä¸­æ–‡æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸åŠ è½½';
      }

      info.appendChild(title);

      // ç»„è£…å¡ç‰‡
      card.appendChild(cover);
      card.appendChild(info);

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      card.addEventListener('click', function(event) {
        event.stopPropagation();

        // ä½¿ç”¨å¤„ç†è¿‡çš„è·¯å¾„
        const sanitizedPath = sanitizeDropboxPath(book.path_lower);
        console.log(`å¤„ç†åçš„è·¯å¾„: ${sanitizedPath}`);

        loadBookFromDropbox(sanitizedPath);
        closeDrawer();
      });

      // å¼‚æ­¥åŠ è½½å°é¢
      setTimeout(() => {
        extractCoverFromDropbox(book.path_lower).then(coverUrl => {
          // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
          if (loadingIndicator.parentNode) {
            loadingIndicator.parentNode.removeChild(loadingIndicator);
          }

          if (coverUrl) {
            // è®¾ç½®å°é¢å›¾ç‰‡
            cover.style.backgroundImage = `url(${coverUrl})`;
            cover.style.backgroundSize = 'cover';
            cover.style.backgroundPosition = 'center';
            cover.style.backgroundRepeat = 'no-repeat';
            cover.textContent = '';
          } else {
            // å¦‚æœæ²¡æœ‰å°é¢ï¼Œæ˜¾ç¤ºé¦–å­—æ¯
            cover.textContent = bookName.charAt(0).toUpperCase();
            cover.style.display = 'flex';
            cover.style.alignItems = 'center';
            cover.style.justifyContent = 'center';
            cover.style.fontSize = '24px';
          }
        });
      }, 10);

      return card;
    }

    // ä» Dropbox åŠ è½½ä¹¦ç±
    async function loadBookFromDropbox(path) {
      try {
        const accessToken = localStorage.getItem('dropboxAccessToken');
        if (!accessToken) {
          console.error('æœªæ‰¾åˆ° Dropbox è®¿é—®ä»¤ç‰Œ');
          return;
        }

        console.log(`æ­£åœ¨ä» Dropbox åŠ è½½ä¹¦ç±: ${path}`);

        // ä½¿ç”¨Dropboxå®˜æ–¹æ¨èçš„æ–¹å¼å¤„ç†APIå‚æ•°
        // åˆ›å»ºå‚æ•°å¯¹è±¡
        const argObj = { path: path };

        // ä½¿ç”¨httpHeaderSafeJsonå‡½æ•°å¤„ç†JSONï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®ç¼–ç 
        const safeArg = httpHeaderSafeJson(argObj);

        console.log('å®‰å…¨ç¼–ç åçš„Dropbox APIå‚æ•°:', safeArg);

        // åˆ›å»ºè¯·æ±‚å¤´
        const headers = {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/octet-stream',
          'Dropbox-API-Arg': safeArg
        };

        console.log('å‘é€è¯·æ±‚å¤´:', JSON.stringify(headers));

        // ä¸‹è½½æ–‡ä»¶
        const response = await fetch('https://content.dropboxapi.com/2/files/download', {
          method: 'POST',
          headers: headers
        });

        if (!response.ok) {
          // å°è¯•è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMessage = `Dropbox API é”™è¯¯: ${response.status}`;
          try {
            const errorData = await response.text();
            console.error('Dropbox API é”™è¯¯è¯¦æƒ…:', errorData);
            errorMessage += ` - ${errorData}`;
          } catch (e) {
            console.error('æ— æ³•è§£æé”™è¯¯è¯¦æƒ…:', e);
          }
          throw new Error(errorMessage);
        }

        // è·å–æ–‡ä»¶å†…å®¹
        const arrayBuffer = await response.arrayBuffer();

        // è·å–æ–‡ä»¶å
        const fileName = path.split('/').pop();

        // åˆ›å»ºçœŸæ­£çš„Blobå¯¹è±¡
        const blob = new Blob([arrayBuffer], {type: 'application/epub+zip'});

        // åˆ›å»ºçœŸæ­£çš„Fileå¯¹è±¡
        const file = new File([blob], fileName, {type: 'application/epub+zip'});

        console.log('åˆ›å»ºçš„Fileå¯¹è±¡:', file);

        // å¤„ç†æ–‡ä»¶
        window.handleFile(file);
      } catch (error) {
        console.error('ä» Dropbox åŠ è½½ä¹¦ç±å¤±è´¥:', error);
        alert('æ— æ³•åŠ è½½ä¹¦ç±ï¼Œè¯·é‡è¯•ã€‚');
      }
    }

    // æ£€æŸ¥ Dropbox æˆæƒçŠ¶æ€
    function checkDropboxAuthStatus() {
      const accessToken = localStorage.getItem('dropboxAccessToken');
      const tokenExpiry = localStorage.getItem('dropboxTokenExpiry');

      if (accessToken) {
        // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
        if (tokenExpiry) {
          const now = new Date().getTime();
          if (now < parseInt(tokenExpiry)) {
            console.log('Dropbox è®¿é—®ä»¤ç‰Œæœ‰æ•ˆ');
            updateDropboxAuthUI(true);
            return true;
          } else {
            console.log('Dropbox è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ');
            // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ·æ–°ä»¤ç‰Œçš„é€»è¾‘
          }
        } else {
          // æ²¡æœ‰è¿‡æœŸæ—¶é—´ä¿¡æ¯ï¼Œå‡è®¾ä»¤ç‰Œæœ‰æ•ˆ
          console.log('Dropbox è®¿é—®ä»¤ç‰Œå­˜åœ¨ï¼ˆæ— è¿‡æœŸä¿¡æ¯ï¼‰');
          updateDropboxAuthUI(true);
          return true;
        }
      }

      console.log('æœªè¿æ¥ Dropbox æˆ–ä»¤ç‰Œå·²è¿‡æœŸ');
      updateDropboxAuthUI(false);
      return false;
    }

    // é¡¶éƒ¨æŠ½å±‰æ§åˆ¶å‡½æ•°
    function setupDrawer() {
      const drawerTrigger = document.getElementById('drawer-trigger');
      const topDrawer = document.getElementById('top-drawer');
      const uploadArea = document.getElementById('upload-area');
      const uploadBookInput = document.getElementById('upload-book');

      // æ‰“å¼€æŠ½å±‰
      function openDrawer() {
        topDrawer.classList.add('open');
      }

      // å…³é—­æŠ½å±‰
      function closeDrawer() {
        topDrawer.classList.remove('open');
      }

      // å…¨å±€å¯è®¿é—®çš„å…³é—­æŠ½å±‰å‡½æ•°
      window.closeDrawer = closeDrawer;

      // ç‚¹å‡»è§¦å‘åŒºåŸŸäº‹ä»¶ - åˆ‡æ¢æŠ½å±‰æ˜¾ç¤ºçŠ¶æ€
      drawerTrigger.addEventListener('click', function() {
        if (topDrawer.classList.contains('open')) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });

      // ç‚¹å‡»é¡µé¢åŒºåŸŸå¤„ç†
      document.addEventListener('click', function(event) {
        // å¦‚æœæŠ½å±‰æ˜¯æ‰“å¼€çš„ï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯è§¦å‘å™¨ï¼Œä¹Ÿä¸æ˜¯æŠ½å±‰æœ¬èº«ï¼Œåˆ™å…³é—­æŠ½å±‰
        if (
          topDrawer.classList.contains('open') &&
          !drawerTrigger.contains(event.target) &&
          !topDrawer.contains(event.target)
        ) {
          // å…³é—­æŠ½å±‰
          closeDrawer();
        }
      });

      // è®¾ç½® Dropbox æˆæƒæŒ‰é’®äº‹ä»¶
      const dropboxAuthButton = document.getElementById('dropbox-auth-button');
      if (dropboxAuthButton) {
        dropboxAuthButton.addEventListener('click', function(event) {
          // é˜»æ­¢äº‹ä»¶å†’æ³¡
          event.stopPropagation();
          // å¤„ç† Dropbox æˆæƒ
          handleDropboxAuth();
        });
      }

      // æ·»åŠ æŠ½å±‰æ‹–åŠ¨åŠŸèƒ½
      const booksContainer = document.getElementById('dropbox-books-container');
      if (booksContainer) {
        let isDragging = false;
        let startX = 0;
        let scrollLeft = 0;

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        booksContainer.addEventListener('mousedown', function(e) {
          isDragging = true;
          startX = e.pageX - booksContainer.offsetLeft;
          scrollLeft = booksContainer.scrollLeft;
        });

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        booksContainer.addEventListener('mousemove', function(e) {
          if (!isDragging) return;
          e.preventDefault();
          const x = e.pageX - booksContainer.offsetLeft;
          const walkX = (x - startX) * 2; // æ»šåŠ¨é€Ÿåº¦
          booksContainer.scrollLeft = scrollLeft - walkX;
        });

        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        booksContainer.addEventListener('mouseup', function() {
          isDragging = false;
        });

        // é¼ æ ‡ç¦»å¼€äº‹ä»¶
        booksContainer.addEventListener('mouseleave', function() {
          isDragging = false;
        });

        // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        booksContainer.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1) {
            isDragging = true;
            startX = e.touches[0].pageX - booksContainer.offsetLeft;
            scrollLeft = booksContainer.scrollLeft;
          }
        });

        booksContainer.addEventListener('touchmove', function(e) {
          if (!isDragging || e.touches.length !== 1) return;
          e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
          const x = e.touches[0].pageX - booksContainer.offsetLeft;
          const walkX = (x - startX) * 2;
          booksContainer.scrollLeft = scrollLeft - walkX;
        });

        booksContainer.addEventListener('touchend', function() {
          isDragging = false;
        });
      }

      // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
      if (uploadArea && uploadBookInput) {
        uploadArea.addEventListener('click', function(event) {
          // é˜»æ­¢äº‹ä»¶å†’æ³¡
          event.stopPropagation();
          uploadBookInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        uploadBookInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file && file.name.toLowerCase().endsWith('.epub')) {
            // å¦‚æœå·²è¿æ¥ Dropboxï¼Œä¸Šä¼ åˆ° Dropbox
            const accessToken = localStorage.getItem('dropboxAccessToken');
            if (accessToken) {
              // å…ˆæå–å°é¢ï¼Œç„¶åä¸Šä¼ åˆ°Dropbox
              extractCoverFromEpub(file).then(() => {
                uploadToDropbox(file);
              });
            } else {
              // å¦åˆ™ç›´æ¥å¤„ç†æ–‡ä»¶
              // å…ˆæå–å°é¢ï¼Œç„¶åå¤„ç†æ–‡ä»¶
              extractCoverFromEpub(file).then(() => {
                window.handleFile(file);
              });
            }
            // å…³é—­æŠ½å±‰
            closeDrawer();
          }
        });
      }
    }

    // ä¸Šä¼ æ–‡ä»¶åˆ° Dropbox
    async function uploadToDropbox(file) {
      try {
        const accessToken = localStorage.getItem('dropboxAccessToken');
        if (!accessToken) {
          console.error('æœªæ‰¾åˆ° Dropbox è®¿é—®ä»¤ç‰Œ');
          return;
        }

        console.log(`æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ° Dropbox: ${file.name}`);

        // è¯»å–æ–‡ä»¶å†…å®¹
        const arrayBuffer = await file.arrayBuffer();

        // å‡†å¤‡Dropbox APIå‚æ•°
        const fileName = file.name;
        console.log(`å‡†å¤‡ä¸Šä¼ æ–‡ä»¶: ${fileName}`);

        // æ„å»ºAPIå‚æ•°å¯¹è±¡
        const argObj = {
          path: `/${fileName}`,
          mode: 'add',
          autorename: true,
          mute: false
        };

        // ä½¿ç”¨httpHeaderSafeJsonå‡½æ•°å¤„ç†JSONï¼Œç¡®ä¿éASCIIå­—ç¬¦è¢«æ­£ç¡®ç¼–ç 
        const safeArg = httpHeaderSafeJson(argObj);
        console.log('å®‰å…¨ç¼–ç åçš„ä¸Šä¼ å‚æ•°:', safeArg);

        // åˆ›å»ºè¯·æ±‚å¤´
        const headers = {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/octet-stream',
          'Dropbox-API-Arg': safeArg
        };

        console.log('ä¸Šä¼ è¯·æ±‚å¤´:', JSON.stringify(headers));

        // ä¸Šä¼ åˆ° Dropbox
        const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
          method: 'POST',
          headers: headers,
          body: arrayBuffer
        });

        if (!response.ok) {
          // å°è¯•è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMessage = `Dropbox API é”™è¯¯: ${response.status}`;
          try {
            const errorData = await response.text();
            console.error('Dropbox API ä¸Šä¼ é”™è¯¯è¯¦æƒ…:', errorData);
            errorMessage += ` - ${errorData}`;
          } catch (e) {
            console.error('æ— æ³•è§£æä¸Šä¼ é”™è¯¯è¯¦æƒ…:', e);
          }
          throw new Error(errorMessage);
        }

        console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');

        // å¤„ç†æ–‡ä»¶
        window.handleFile(file);

        // åˆ·æ–°ä¹¦ç±åˆ—è¡¨
        loadDropboxBooks();
      } catch (error) {
        console.error('ä¸Šä¼ æ–‡ä»¶åˆ° Dropbox å¤±è´¥:', error);
        alert('ä¸Šä¼ æ–‡ä»¶åˆ° Dropbox å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');

        // å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œä»ç„¶å¤„ç†æ–‡ä»¶
        window.handleFile(file);
      }
    }

    // åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šä¹‰handleFileå‡½æ•°ï¼Œç¡®ä¿å®ƒåœ¨é¡µé¢åŠ è½½å‰å°±å¯ç”¨
    window.handleFile = function(file) {
      console.log('å…¨å±€handleFileå‡½æ•°è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file ? file.name : 'undefined');

      // å¦‚æœæ–‡æ¡£å·²åŠ è½½å®Œæˆï¼Œç›´æ¥å¤„ç†æ–‡ä»¶
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log('æ–‡æ¡£å·²åŠ è½½ï¼Œç›´æ¥å¤„ç†æ–‡ä»¶');
        // è¿™é‡Œä¸èƒ½ç›´æ¥è°ƒç”¨handleFileInternalï¼Œå› ä¸ºå®ƒè¿˜æ²¡æœ‰å®šä¹‰
        // ç›¸åï¼Œæˆ‘ä»¬å°†æ–‡ä»¶ä¿å­˜åˆ°ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶å¤„ç†
        window._pendingFile = file;
      } else {
        // å¦‚æœæ–‡æ¡£å°šæœªåŠ è½½å®Œæˆï¼Œä¿å­˜æ–‡ä»¶å¹¶ç­‰å¾…DOMContentLoadedäº‹ä»¶
        console.log('æ–‡æ¡£å°šæœªåŠ è½½ï¼Œä¿å­˜æ–‡ä»¶ç­‰å¾…å¤„ç†');
        window._pendingFile = file;
      }
    };

    document.addEventListener('DOMContentLoaded', async function() {
      // è®¾ç½®é¡¶éƒ¨æŠ½å±‰
      setupDrawer();

      // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰æˆæƒç 
      handleDropboxRedirect();

      // æ£€æŸ¥ Dropbox æˆæƒçŠ¶æ€å¹¶æ›´æ–° UI
      const isAuthorized = checkDropboxAuthStatus();

      // æ£€æŸ¥ePub.jsæ˜¯å¦æ­£ç¡®åŠ è½½
      if (typeof ePub === 'undefined') {
        alert('Error: ePub.js library could not be loaded. Please check your internet connection and try again.');
        return;
      }

      // å¦‚æœå·²æˆæƒDropboxï¼Œå°è¯•åŠ è½½é˜…è¯»è¿›åº¦å’Œä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±
      if (isAuthorized) {
        try {
          console.log('å°è¯•ä»DropboxåŠ è½½é˜…è¯»è¿›åº¦...');

          // åŠ è½½é˜…è¯»è¿›åº¦
          await progressSync.loadFromDropbox();

          // å°è¯•åŠ è½½ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±
          const bookLoaded = await progressSync.loadCurrentBook();

          if (bookLoaded) {
            console.log('æˆåŠŸåŠ è½½ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±');
          } else {
            console.log('æ²¡æœ‰æ‰¾åˆ°ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±æˆ–åŠ è½½å¤±è´¥');
          }
        } catch (error) {
          console.error('åŠ è½½é˜…è¯»è¿›åº¦æˆ–ä¹¦ç±æ—¶å‡ºé”™:', error);
        }
      }
      // è·å–DOMå…ƒç´ 
      const dropArea = document.getElementById('drop-area');
      const epubViewer = document.getElementById('epub-viewer');
      const notesTextarea = document.getElementById('notes');
      const notesArea = document.getElementById('notes-area');
      const notesToggle = document.getElementById('notes-toggle');
      // ç§»é™¤äº†è°ƒè¯•æŒ‰é’®ç›¸å…³å˜é‡
      // ç§»é™¤äº†ç´§æ€¥å¯¼èˆªæŒ‰é’®ç›¸å…³å˜é‡

      // å…¨å±€å˜é‡
      let book;
      let rendition;  // æ¸²æŸ“å™¨
      let currentBook = null;
      let currentNotes = {};
      let currentLocation = 0; // å½“å‰ä½ç½®
      let totalLocations = 0;  // æ€»ä½ç½®æ•°

      // æ›´æ–°é¡µé¢æ˜¾ç¤º - å…¨å±€å‡½æ•°
      function updatePages(startLocation) {
        // ç¡®ä¿ä½ç½®åœ¨æœ‰æ•ˆèŒƒå›´å†…
        if (startLocation < 0) startLocation = 0;
        if (startLocation >= totalLocations) startLocation = totalLocations - 1;

        // æ›´æ–°å½“å‰ä½ç½®
        currentLocation = startLocation;

        // ä½¿ç”¨ä½ç½®ç´¢å¼•ï¼ˆè½¬æ¢ä¸ºCFIï¼‰
        const cfi = book.locations.cfiFromLocation(startLocation);

        // æ˜¾ç¤ºé¡µé¢
        rendition.display(cfi).then(() => {
          // æ›´æ–°è¿›åº¦æ˜¾ç¤º
          updateProgressInfo();

          // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æœ¬åœ°ï¼Œä½†ä¸ä¿å­˜åˆ°Dropboxï¼ˆé¿å…åˆå§‹åŠ è½½æ—¶é¢‘ç¹ä¿å­˜ï¼‰
          if (currentBook) {
            // åªä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸ä¿å­˜åˆ°Dropbox
            progressSync.updateBookProgress(currentBook, currentLocation.toString(), false);
          }
        }).catch(error => {
          console.error('é¡µé¢æ˜¾ç¤ºé”™è¯¯:', error);
        });
      }

      // æ›´æ–°è¿›åº¦ä¿¡æ¯æ˜¾ç¤º
      function updateProgressInfo() {
        if (!book || !rendition) return;

        try {
          // è®¡ç®—ç™¾åˆ†æ¯”è¿›åº¦
          const percentage = Math.floor((currentLocation / totalLocations) * 100);

          // æ„å»ºè¿›åº¦ä¿¡æ¯
          let progressInfo = `${percentage}%`;

          // æ·»åŠ ä½ç½®ä¿¡æ¯
          progressInfo += ` | ä½ç½®: ${currentLocation+1}/${totalLocations}`;

          // å°è¯•è·å–å½“å‰ç« èŠ‚ä¿¡æ¯
          try {
            const currentLoc = rendition.location;
            if (currentLoc && currentLoc.start) {
              // è·å–ç« èŠ‚è·¯å¾„
              const chapter = currentLoc.start.href || '';

              // ä»ç« èŠ‚è·¯å¾„ä¸­æå–ç« èŠ‚åç§°
              let chapterName = chapter.split('/').pop().replace('.html', '');

              // å°è¯•æ¸…ç†ç« èŠ‚åç§°ï¼ˆç§»é™¤æ•°å­—å‰ç¼€ç­‰ï¼‰
              chapterName = chapterName.replace(/^\d+[\._-]?/, '');
              chapterName = chapterName.replace(/_/g, ' ');

              if (chapterName) {
                progressInfo += ` | ${chapterName}`;
              }

              // å°è¯•è·å–ç« èŠ‚æ ‡é¢˜
              if (currentLoc.start.index) {
                const spineItem = book.spine.get(currentLoc.start.index);
                if (spineItem && spineItem.title) {
                  progressInfo += ` (${spineItem.title})`;
                }
              }
            }
          } catch (e) {
            // å¿½ç•¥ç« èŠ‚è·å–é”™è¯¯
          }

          // æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º
          const pageInfoElement = document.getElementById('page-info');
          if (pageInfoElement) {
            pageInfoElement.textContent = progressInfo;
          }

          // æ›´æ–°å³ä¸‹è§’é¡µç æ˜¾ç¤º
          const pageCounterElement = document.getElementById('page-counter');
          if (pageCounterElement) {
            // ç®€æ´æ˜¾ç¤ºï¼šå½“å‰é¡µ/æ€»é¡µæ•°
            pageCounterElement.textContent = `${currentLocation+1}/${totalLocations}`;
          }
        } catch (error) {
          console.error('æ›´æ–°è¿›åº¦ä¿¡æ¯å‡ºé”™:', error);
        }
      }

      // å°†updateProgressInfoå‡½æ•°æ·»åŠ åˆ°windowå¯¹è±¡ï¼Œä½¿å…¶åœ¨æ‰€æœ‰ä½œç”¨åŸŸä¸­å¯ç”¨
      window.updateProgressInfo = updateProgressInfo;

      // åŠ è½½ä¿å­˜çš„ç¬”è®°
      try {
        const savedNotes = localStorage.getItem('epub-reader-notes');
        if (savedNotes) {
          currentNotes = JSON.parse(savedNotes);
        }
      } catch (error) {
        console.error('Error loading saved notes:', error);
      }

      // å¤„ç†æ‹–æ”¾äº‹ä»¶ - ä½¿ç”¨ç»Ÿä¸€çš„å¤„ç†å‡½æ•°
      // å¤„ç†æ‹–æ”¾åŒºåŸŸæ ·å¼
      function handleDragOver(event) {
        event.preventDefault();

        // å¦‚æœåº“æœªåŠ è½½å®Œæˆï¼Œä¸å¤„ç†
        if (!window.librariesReady) return;

        // æ˜¾ç¤ºæ‹–æ”¾åŒºåŸŸ
        if (dropArea.classList.contains('hidden')) {
          dropArea.classList.remove('hidden');
        }

        // è®¾ç½®æ ·å¼
        dropArea.style.borderColor = '#4a4238';
        dropArea.style.backgroundColor = 'rgba(74, 66, 56, 0.1)';
      }

      // å¤„ç†æ‹–æ”¾ç¦»å¼€
      function handleDragLeave() {
        // å¦‚æœåº“æœªåŠ è½½å®Œæˆï¼Œä¸å¤„ç†
        if (!window.librariesReady) return;

        // é‡ç½®æ ·å¼
        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
      }

      // å¤„ç†æ–‡ä»¶æ‹–æ”¾
      function handleFileDrop(event) {
        event.preventDefault();

        // å¦‚æœåº“æœªåŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºæç¤º
        if (!window.librariesReady) {
          alert('Libraries are still loading. Please wait a moment and try again.');
          console.log('Error: Libraries not ready yet');
          return;
        }

        // é‡ç½®æ ·å¼
        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';

        try {
          // è·å–æ‹–æ”¾çš„æ–‡ä»¶
          const file = event.dataTransfer.files[0];
          if (file && file.name.toLowerCase().endsWith('.epub')) {
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ‰§è¡Œï¼Œç»™æµè§ˆå™¨æ—¶é—´å¤„ç†UIæ›´æ–°
            setTimeout(function() {
              try {
                // å¤„ç†æ–°æ–‡ä»¶
                window.handleFile(file);
              } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
              }
            }, 100);
          }
        } catch (error) {
          console.error('å¤„ç†æ‹–æ”¾äº‹ä»¶æ—¶å‡ºé”™:', error);
        }
      }

      // ä¸ºæ•´ä¸ªæ–‡æ¡£æ·»åŠ æ‹–æ”¾äº‹ä»¶
      document.addEventListener('dragover', handleDragOver);
      document.addEventListener('dragleave', handleDragLeave);
      document.addEventListener('drop', handleFileDrop);

      // ä¸ºdropAreaä¹Ÿæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆç¡®ä¿å…¼å®¹æ€§ï¼‰
      dropArea.addEventListener('dragover', handleDragOver);
      dropArea.addEventListener('dragleave', handleDragLeave);
      dropArea.addEventListener('drop', handleFileDrop);

      // ç§»é™¤äº†ç¤ºä¾‹EPUBåŠ è½½åŠŸèƒ½

      // è¿™é‡Œå·²ç»åœ¨å‰é¢å®šä¹‰äº†debounceå‡½æ•°ï¼Œä¸éœ€è¦é‡å¤å®šä¹‰

      // ä¿å­˜ç¬”è®°å‡½æ•° - æå–ä¸ºç‹¬ç«‹å‡½æ•°é¿å…ä»£ç é‡å¤
      function saveNotes() {
        if (currentBook) {
          currentNotes[currentBook] = notesTextarea.value;
          localStorage.setItem('epub-reader-notes', JSON.stringify(currentNotes));
        }
      }

      // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–ç¬”è®°ä¿å­˜ - 500mså†…åªä¿å­˜ä¸€æ¬¡
      const debouncedSaveNotes = debounce(saveNotes, 500);

      // è®¾ç½®è‡ªåŠ¨ä¿å­˜ç¬”è®° - ä½¿ç”¨é˜²æŠ–å‡½æ•°
      notesTextarea.addEventListener('input', debouncedSaveNotes);

      // æ·»åŠ ç¬”è®°åŒºåŸŸçš„ç„¦ç‚¹çŠ¶æ€ç®¡ç†
      let isNotesActive = false; // å…¨å±€å˜é‡ï¼Œè·Ÿè¸ªç¬”è®°åŒºåŸŸæ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€

      // å½“ç¬”è®°åŒºåŸŸè·å¾—ç„¦ç‚¹æ—¶
      notesTextarea.addEventListener('focus', function() {
        isNotesActive = true;
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§†è§‰æç¤ºï¼Œä¾‹å¦‚æ”¹å˜è¾¹æ¡†é¢œè‰²
        notesTextarea.style.outline = '2px solid #4a4238';
      });

      // å½“ç¬”è®°åŒºåŸŸå¤±å»ç„¦ç‚¹æ—¶
      notesTextarea.addEventListener('blur', function() {
        isNotesActive = false;
        // ç§»é™¤è§†è§‰æç¤º
        notesTextarea.style.outline = 'none';

        // ç«‹å³ä¿å­˜ç¬”è®°å†…å®¹ï¼ˆä¸ä½¿ç”¨é˜²æŠ–ï¼‰
        saveNotes();
      });

      // æ›´æ–°ç¬”è®°åŒºåŸŸçš„ç®­å¤´æ–¹å‘
      function updateNotesToggleIcon(isExpanded) {
        const icon = notesToggle.querySelector('.icon');
        if (isExpanded) {
          icon.textContent = '<'; // å±•å¼€çŠ¶æ€æ˜¾ç¤ºå·¦ç®­å¤´ï¼ˆæŒ‡å‘æ”¶èµ·æ–¹å‘ï¼‰
        } else {
          icon.textContent = '>'; // æ”¶èµ·çŠ¶æ€æ˜¾ç¤ºå³ç®­å¤´ï¼ˆæŒ‡å‘å±•å¼€æ–¹å‘ï¼‰
        }
      }

      // é‡æ–°æ¸²æŸ“ç”µå­ä¹¦å‡½æ•° - æå–ä¸ºç‹¬ç«‹å‡½æ•°é¿å…ä»£ç é‡å¤
      function rerenderBook() {
        if (!book || !rendition) return;

        // è·å–å½“å‰å®¹å™¨å°ºå¯¸
        const container = document.getElementById('epub-container');
        const newWidth = container.clientWidth;
        const newHeight = container.clientHeight;

        // è°ƒæ•´æ¸²æŸ“å™¨å°ºå¯¸
        rendition.resize(newWidth, newHeight);

        // ä½¿ç”¨å½“å‰ä½ç½®é‡æ–°æ¸²æŸ“
        try {
          const location = rendition.location;
          if (location && location.start) {
            rendition.display(location.start.cfi);
          } else {
            // å¦‚æœæ— æ³•è·å–å½“å‰ä½ç½®ï¼Œä½¿ç”¨ä¿å­˜çš„ä½ç½®
            const cfi = book.locations.cfiFromLocation(currentLocation);
            rendition.display(cfi);
          }
        } catch (error) {
          // ä½¿ç”¨ä¿å­˜çš„ä½ç½®
          const cfi = book.locations.cfiFromLocation(currentLocation);
          rendition.display(cfi);
        }
      }

      // è®¾ç½®ç¬”è®°åŒºåŸŸçš„å±•å¼€çŠ¶æ€
      function setNotesAreaExpanded(isExpanded, rerender = true) {
        // æ›´æ–°DOMçŠ¶æ€
        if (isExpanded) {
          notesArea.classList.add('expanded');
        } else {
          notesArea.classList.remove('expanded');
        }

        // æ›´æ–°ç®­å¤´æ–¹å‘
        updateNotesToggleIcon(isExpanded);

        // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('notes-expanded', isExpanded ? 'true' : 'false');

        // å¦‚æœéœ€è¦é‡æ–°æ¸²æŸ“ï¼Œä¸”ä¹¦ç±å’Œæ¸²æŸ“å™¨å·²åŠ è½½
        if (rerender && book && rendition) {
          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
          notesArea.removeEventListener('transitionend', rerenderBook);

          // æ·»åŠ è¿‡æ¸¡ç»“æŸäº‹ä»¶ç›‘å¬å™¨ï¼Œåªåœ¨è¿‡æ¸¡åŠ¨ç”»ç»“æŸæ—¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡
          notesArea.addEventListener('transitionend', rerenderBook, { once: true });

          // ä¸ºäº†å…¼å®¹æ€§ï¼Œä¹Ÿæ·»åŠ ä¸€ä¸ªå¤‡ç”¨çš„å®šæ—¶å™¨ï¼Œç¡®ä¿å³ä½¿transitionendäº‹ä»¶æ²¡æœ‰è§¦å‘ä¹Ÿèƒ½é‡æ–°æ¸²æŸ“
          if (window.notesAnimationTimer) {
            clearTimeout(window.notesAnimationTimer);
          }
          window.notesAnimationTimer = setTimeout(rerenderBook, 350); // ç•¥å¤§äºCSSè¿‡æ¸¡æ—¶é—´
        }
      }

      // å¤„ç†ç¬”è®°åŒºåŸŸçš„å±•å¼€/æ”¶èµ·
      notesToggle.addEventListener('click', function() {
        const isExpanded = !notesArea.classList.contains('expanded');
        setNotesAreaExpanded(isExpanded);
      });

      // æ¢å¤ç¬”è®°åŒºåŸŸçŠ¶æ€
      function restoreNotesAreaState() {
        const expanded = localStorage.getItem('notes-expanded') === 'true';
        setNotesAreaExpanded(expanded, false); // ä¸é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºæ­¤æ—¶ä¹¦ç±å¯èƒ½å°šæœªåŠ è½½
      }

      // é¡µé¢åŠ è½½æ—¶æ¢å¤ç¬”è®°åŒºåŸŸçŠ¶æ€
      restoreNotesAreaState();

      // å¸è½½å½“å‰ä¹¦ç± - æç®€ç‰ˆæœ¬
      function unloadCurrentBook() {
        try {
          // ä¿å­˜å½“å‰ç¬”è®°
          if (currentBook && notesTextarea) {
            currentNotes[currentBook] = notesTextarea.value;
            localStorage.setItem('epub-reader-notes', JSON.stringify(currentNotes));
          }

          // ä¿å­˜å½“å‰é˜…è¯»è¿›åº¦åˆ°æœ¬åœ°å’ŒDropbox
          if (currentBook && currentLocation >= 0) {
            // ä½¿ç”¨è¿›åº¦åŒæ­¥æ¨¡å—æ›´æ–°è¿›åº¦ï¼Œå¹¶æŒ‡å®šä¿å­˜åˆ°äº‘ç«¯
            progressSync.updateBookProgress(currentBook, currentLocation.toString(), true);
          }

          // æ¸…ç©ºå®¹å™¨ - è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†
          const epubContainer = document.getElementById('epub-container');
          if (epubContainer) {
            epubContainer.innerHTML = '';
          }

          // ç®€å•åœ°é‡ç½®å˜é‡ï¼Œä¸å°è¯•æ¸…ç†å¯¹è±¡
          book = null;
          rendition = null;

          // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå°½ç®¡è¿™ä¸æ˜¯ç›´æ¥çš„æ–¹æ³•ï¼‰
          if (window.gc) {
            window.gc();
          }

        } catch (e) {
          console.error('å¸è½½ä¹¦ç±æ—¶å‡ºé”™:', e);

          // å³ä½¿å‡ºé”™ï¼Œä¹Ÿè¦ç¡®ä¿å®¹å™¨è¢«æ¸…ç©º
          try {
            const epubContainer = document.getElementById('epub-container');
            if (epubContainer) {
              epubContainer.innerHTML = '';
            }

            // é‡ç½®å˜é‡
            book = null;
            rendition = null;
          } catch (innerError) {
            console.error('æ¸…ç©ºå®¹å™¨æ—¶å‡ºé”™:', innerError);
          }
        }
      }

      // è¿™ä¸ªå‡½æ•°å°†åœ¨DOMContentLoadedäº‹ä»¶å¤„ç†ç¨‹åºä¸­ä½¿ç”¨
      function handleFileInternal(file) {
        // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
        if (!window.librariesReady) {
          alert('Libraries are still loading. Please wait a moment and try again.');
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯EPUBæ–‡ä»¶
        if (!file.name.toLowerCase().endsWith('.epub')) {
          alert('Please upload an EPUB file.');
          return;
        }

        // å¦‚æœå½“å‰å·²æœ‰ä¹¦ç±åŠ è½½ï¼Œå…ˆå¸è½½å®ƒ
        unloadCurrentBook();

        // è®¾ç½®å½“å‰ä¹¦ç±
        currentBook = file.name;

        // éšè—æ‹–æ”¾åŒºåŸŸ
        dropArea.classList.add('hidden');

        try {
          // æ£€æŸ¥JSZipæ˜¯å¦å·²åŠ è½½
          if (typeof JSZip === 'undefined') {
            throw new Error('JSZip library is not loaded. Cannot process EPUB file.');
          }

          // æ£€æŸ¥ePub.jsæ˜¯å¦å·²åŠ è½½
          if (typeof ePub === 'undefined') {
            throw new Error('ePub.js library is not loaded. Cannot process EPUB file.');
          }

          try {
            // åˆ›å»ºbookå¯¹è±¡
            book = ePub();

            // æ·»åŠ å¿…è¦çš„äº‹ä»¶ç›‘å¬å™¨
            book.on('rendition:error', function(error) {
              console.error('æ¸²æŸ“é”™è¯¯:', error);
            });

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„Fileæˆ–Blobå¯¹è±¡
            if (!(file instanceof Blob)) {
              console.error('æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„Blobå¯¹è±¡:', file);
              alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•åŠ è½½ã€‚');
              return;
            }

            console.log('å¤„ç†æ–‡ä»¶:', file);

            // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶ä¸ºArrayBuffer
            const reader = new FileReader();

            reader.onload = function(e) {
              const arrayBuffer = e.target.result;
              console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¤§å°:', arrayBuffer.byteLength);

              // ä½¿ç”¨ArrayBufferæ‰“å¼€æ–‡ä»¶
              book.open(arrayBuffer)
                .then(function() {
                // æ¸…ç©ºå®¹å™¨ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™å†…å®¹
                const epubContainer = document.getElementById('epub-container');
                if (epubContainer) {
                  epubContainer.innerHTML = '';
                } else {
                  console.error('æ‰¾ä¸åˆ°epub-containerå…ƒç´ ï¼Œæ— æ³•æ¸…ç©ºå†…å®¹');
                }

                // è·å–å®¹å™¨å°ºå¯¸
                const container = document.getElementById('epub-container');
                const containerWidth = container ? container.clientWidth : 0;
                const containerHeight = container ? container.clientHeight : 0;
                rendition = book.renderTo('epub-container', {
                  width: containerWidth,
                  height: containerHeight,
                  spread: 'both',  // å¯ç”¨åŒé¡µæ˜¾ç¤º
                  flow: 'paginated',
                  manager: 'default',
                  allowScriptedContent: true,
                  allowPopups: false,
                });

                // ç”Ÿæˆä½ç½®ä¿¡æ¯
                book.ready.then(() => {
                  // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä½ç½®ä¿¡æ¯
                  const storedLocations = localStorage.getItem(`${currentBook}-locations`);

                  if (storedLocations) {
                    // å¦‚æœæœ‰ä¿å­˜çš„ä½ç½®ä¿¡æ¯ï¼Œç›´æ¥åŠ è½½
                    return book.locations.load(JSON.parse(storedLocations));
                  } else {
                    // å¦åˆ™ç”Ÿæˆæ–°çš„ä½ç½®ä¿¡æ¯
                    return book.locations.generate(1024).then(locations => {
                      // ä¿å­˜ä½ç½®ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
                      localStorage.setItem(`${currentBook}-locations`, JSON.stringify(locations));
                      return locations;
                    });
                  }
                }).then((locations) => {
                  totalLocations = book.locations.total;

                  // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„é˜…è¯»è¿›åº¦
                  const storedProgress = localStorage.getItem(`${currentBook}-progress`);
                  let startLocation = 0;

                  if (storedProgress) {
                    try {
                      startLocation = parseInt(storedProgress, 10);
                    } catch (e) {
                      // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼0
                    }
                  }

                  // åˆå§‹åŒ–æ˜¾ç¤º
                  updatePages(startLocation);

                  // ç§»é™¤äº†é‡å¤çš„æ»šè½®äº‹ä»¶ç›‘å¬å™¨è®¾ç½®ï¼Œæ”¹ä¸ºåœ¨renderedäº‹ä»¶ä¸­æ·»åŠ 
                }).catch(error => {
                  console.error('ä½ç½®ä¿¡æ¯å¤„ç†é”™è¯¯:', error);
                });

                // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
                rendition.on('keydown', function(e) {
                  handleKeyNavigation(e.key);
                });

                // ç»Ÿä¸€çš„é”®ç›˜å¯¼èˆªå¤„ç†å‡½æ•°
                function handleKeyNavigation(key) {
                  if(key == "ArrowLeft") {
                    navigatePrev();
                  }
                  if(key == "ArrowRight") {
                    navigateNext();
                  }
                }

                // æ³¨æ„ï¼šç§»é™¤äº†è¿™é‡Œçš„iframe sandboxè®¾ç½®ï¼Œå› ä¸ºåœ¨renderedäº‹ä»¶ä¸­å·²ç»è®¾ç½®äº†

                // æ£€æŸ¥æ¸²æŸ“å™¨æ˜¯å¦æ­£ç¡®åˆ›å»º
                if (!rendition) {
                  throw new Error('Failed to create rendition');
                }

                // ç›‘å¬ä½†ä¸å¤„ç†ç‚¹å‡»äº‹ä»¶
                rendition.on('click', function(event) {
                  // ä¸å†å°è¯•é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå®šä¹‰å¤„ç†
                  // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰ç‚¹å‡»å¤„ç†é€»è¾‘ï¼Œå¦‚æ˜¾ç¤ºèœå•ç­‰
                });

                // æ·»åŠ ä½ç½®å˜åŒ–äº‹ä»¶ç›‘å¬
                rendition.on('relocated', function(location) {
                  if (location && location.start) {
                    try {
                      const locationCfi = location.start.cfi;
                      const newLocation = book.locations.locationFromCfi(locationCfi);

                      console.log(`ä½ç½®å˜åŒ–: ${currentLocation} -> ${newLocation}`);

                      if (newLocation !== currentLocation) {
                        currentLocation = newLocation;

                        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                        window.updateProgressInfo();

                        // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆè¿™ä¸ªæ“ä½œå¾ˆå¿«ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œï¼‰
                        if (currentBook) {
                          localStorage.setItem(`${currentBook}-progress`, currentLocation.toString());

                          // æ¸…é™¤ä¹‹å‰çš„ä¿å­˜è®¡æ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                          if (window.saveProgressTimer) {
                            clearTimeout(window.saveProgressTimer);
                          }

                          // è®¾ç½®æ–°çš„è®¡æ—¶å™¨ï¼Œç”¨æˆ·åœç•™2ç§’åå†ä¿å­˜åˆ°Dropbox
                          window.saveProgressTimer = setTimeout(() => {
                            console.log(`ç”¨æˆ·åœç•™è¶…è¿‡2ç§’ï¼Œä¿å­˜é˜…è¯»è¿›åº¦åˆ°Dropbox: ${currentBook}, ä½ç½®: ${currentLocation}`);

                            // ä½¿ç”¨è¿›åº¦åŒæ­¥æ¨¡å—æ›´æ–°è¿›åº¦ï¼Œå¹¶æŒ‡å®šä¿å­˜åˆ°äº‘ç«¯
                            progressSync.updateBookProgress(currentBook, currentLocation.toString(), true);
                          }, 2000); // 2ç§’åè§¦å‘ä¿å­˜
                        } else {
                          console.warn('æ— æ³•ä¿å­˜è¿›åº¦ï¼šcurrentBookæœªå®šä¹‰');
                        }
                      }
                    } catch (e) {
                      console.error('æ›´æ–°ä½ç½®æ—¶å‡ºé”™:', e);
                    }
                  }
                });

                // æ·»åŠ å†…å®¹åŠ è½½äº‹ä»¶ç›‘å¬å™¨
                rendition.on('rendered', function(section) {
                  // å†…å®¹æ¸²æŸ“åï¼Œæ·»åŠ æ»šè½®äº‹ä»¶ç›‘å¬å™¨åˆ°æ–°çš„å†…å®¹
                  setTimeout(function() {
                    try {
                      // æŸ¥æ‰¾iframe
                      const container = document.getElementById('epub-container');
                      if (!container) return;

                      const iframe = container.querySelector('iframe');
                      if (!iframe) return;

                      // ç¡®ä¿iframeå·²åŠ è½½
                      if (!iframe.contentDocument && !iframe.contentWindow) return;

                      // è®¿é—®iframeçš„å†…å®¹æ–‡æ¡£
                      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                      if (!iframeDoc) return;

                      // è®¾ç½®sandboxå±æ€§
                      iframe.sandbox = 'allow-same-origin allow-scripts';

                      // ä¸ºiframeå†…éƒ¨æ·»åŠ æ‹–æ”¾äº‹ä»¶å¤„ç†
                      // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢è§¦å‘æµè§ˆå™¨çš„å¦å­˜ä¸ºå¯¹è¯æ¡†
                      iframeDoc.addEventListener('dragover', function(e) {
                        e.preventDefault();

                        // æ˜¾ç¤ºæ‹–æ”¾åŒºåŸŸ
                        if (dropArea && dropArea.classList.contains('hidden')) {
                          dropArea.classList.remove('hidden');
                        }
                      });

                      // å¤„ç†iframeå†…éƒ¨çš„æ–‡ä»¶æ‹–æ”¾
                      iframeDoc.addEventListener('drop', function(e) {
                        e.preventDefault();

                        try {
                          // è·å–æ‹–æ”¾çš„æ–‡ä»¶å¹¶å¤„ç†
                          const file = e.dataTransfer.files[0];
                          if (file && file.name.toLowerCase().endsWith('.epub')) {
                            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ‰§è¡Œï¼Œç»™æµè§ˆå™¨æ—¶é—´å¤„ç†UIæ›´æ–°
                            setTimeout(function() {
                              try {
                                // å¤„ç†æ–°æ–‡ä»¶
                                window.handleFile(file);
                              } catch (error) {
                                console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                              }
                            }, 100);
                          }
                        } catch (error) {
                          console.error('å¤„ç†æ‹–æ”¾äº‹ä»¶æ—¶å‡ºé”™:', error);
                        }
                      });

                      // åˆ›å»ºæ»šè½®äº‹ä»¶ç›‘å¬å™¨
                      const wheelListener = function(event) {
                        // ä¸å†å°è¯•é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè€Œæ˜¯ç›´æ¥å¤„ç†æ»šåŠ¨

                        // è®¾ç½®æ»šåŠ¨é˜ˆå€¼å’Œå†·å´æ—¶é—´
                        const now = Date.now();
                        if (now - (window.lastWheelTime || 0) < 50) return;
                        window.lastWheelTime = now;

                        // æ ¹æ®æ»šåŠ¨æ–¹å‘å¯¼èˆª
                        if (event.deltaY > 2) {
                          // å‘ä¸‹æ»šåŠ¨ï¼Œå‰è¿›åˆ°ä¸‹ä¸€é¡µ
                          window.navigateNext();
                        } else if (event.deltaY < -2) {
                          // å‘ä¸Šæ»šåŠ¨ï¼Œåé€€åˆ°ä¸Šä¸€é¡µ
                          window.navigatePrev();
                        }
                      };

                      // æ·»åŠ ç›‘å¬å™¨ï¼Œä½¿ç”¨passive: trueä»¥é¿å…è­¦å‘Š
                      iframeDoc.addEventListener('wheel', wheelListener, { passive: true });

                      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ç‚¹å‡»iframeå†…å®¹æ—¶ä¹Ÿèƒ½å…³é—­æŠ½å±‰
                      iframeDoc.addEventListener('click', function(e) {
                        // è·å–é¡¶éƒ¨æŠ½å±‰å…ƒç´ 
                        const topDrawer = document.getElementById('top-drawer');
                        // å¦‚æœæŠ½å±‰æ˜¯æ‰“å¼€çš„ï¼Œå…³é—­å®ƒ
                        if (topDrawer && topDrawer.classList.contains('open')) {
                          // è°ƒç”¨å…¨å±€å…³é—­æŠ½å±‰å‡½æ•°
                          window.closeDrawer();
                        }
                      });
                    } catch (e) {
                      console.error('æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ—¶å‡ºé”™:', e);
                    }
                  }, 200);
                });

                // ä¸éœ€è¦åœ¨è¿™é‡Œæ˜¾ç¤ºä¹¦ç±ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šåœ¨ç”Ÿæˆä½ç½®ä¿¡æ¯åè°ƒç”¨updatePages(0)
              })
              .then(function() {
                // åŠ è½½å…ƒæ•°æ®
                return book.loaded.metadata;
              })
              .then(function(metadata) {
                // å…ƒæ•°æ®åŠ è½½å®Œæˆ
              })
              .catch(function(error) {
                alert('Error loading EPUB: ' + error.message);
              });
            };

            reader.onerror = function(error) {
              alert('Error reading file: ' + error);
            };

            // å¼€å§‹è¯»å–æ–‡ä»¶
            reader.readAsArrayBuffer(file);
          } catch (error) {
            alert('Critical error initializing ePub reader: ' + error.message);
          }

          // åŠ è½½ç¬”è®°
          if (currentNotes[currentBook]) {
            notesTextarea.value = currentNotes[currentBook];
          } else {
            notesTextarea.value = '';
          }

          // è®¾ç½®é”®ç›˜å¯¼èˆª
          document.addEventListener('keydown', handleKeyPress);

          // æ·»åŠ çª—å£å¤§å°è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨ - ä½¿ç”¨èŠ‚æµç‰ˆæœ¬
          window.addEventListener('resize', throttledResize);

        } catch (error) {
          console.error('Error in handleFile:', error);
          alert('Error loading EPUB: ' + error.message);
        }
      }

      // å¤„ç†é”®ç›˜å¯¼èˆª
      function handleKeyPress(event) {
        if (!book || !rendition) return;

        // æ£€æŸ¥ç¬”è®°åŒºåŸŸæ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€
        if (isNotesActive) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–‡æœ¬è¾“å…¥å…ƒç´ å¤„äºç„¦ç‚¹çŠ¶æ€
        const activeElement = document.activeElement;
        const isInputActive = activeElement.tagName === 'INPUT' ||
                             activeElement.tagName === 'TEXTAREA' ||
                             activeElement.isContentEditable;

        // å¦‚æœæœ‰è¾“å…¥å…ƒç´ å¤„äºç„¦ç‚¹çŠ¶æ€ï¼Œä¸å¤„ç†é”®ç›˜å¯¼èˆª
        if (isInputActive) return;

        // åªå¤„ç†ç®­å¤´é”®ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
        if (event.key === 'ArrowLeft') {
          window.navigatePrev();
        } else if (event.key === 'ArrowRight') {
          window.navigateNext();
        }
      }

      // æ›´æ–°é˜…è¯»ä½ç½®å‡½æ•° - æå–ä¸ºç‹¬ç«‹å‡½æ•°é¿å…ä»£ç é‡å¤
      function updateReadingPosition() {
        try {
          const location = rendition.location;
          if (location && location.start) {
            const locationCfi = location.start.cfi;
            const newLocation = book.locations.locationFromCfi(locationCfi);
            currentLocation = newLocation;

            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            window.updateProgressInfo();

            // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æœ¬åœ°å’ŒDropbox
            if (currentBook) {
              // ä½¿ç”¨è¿›åº¦åŒæ­¥æ¨¡å—æ›´æ–°è¿›åº¦
              progressSync.updateBookProgress(currentBook, currentLocation.toString());
            }
          }
        } catch (e) {
          console.error('æ›´æ–°ä½ç½®æ—¶å‡ºé”™:', e);
        }
      }

      // å¯¼èˆªåˆ°ä¸Šä¸€é¡µ - ä½¿ç”¨ePub.jså†…ç½®æ–¹æ³•
      function navigatePrev() {
        if (!book || !rendition) return;

        // ä½¿ç”¨renditionçš„prevæ–¹æ³•å¯¼èˆªåˆ°ä¸Šä¸€é¡µ
        rendition.prev().then(function() {
          // å¯¼èˆªæˆåŠŸåæ›´æ–°å½“å‰ä½ç½®
          setTimeout(updateReadingPosition, 100);
        }).catch(function() {
          // å·²ç»æ˜¯ç¬¬ä¸€é¡µ
        });
      }

      // å¯¼èˆªåˆ°ä¸‹ä¸€é¡µ - ä½¿ç”¨ePub.jså†…ç½®æ–¹æ³•
      function navigateNext() {
        if (!book || !rendition) return;

        // ä½¿ç”¨renditionçš„nextæ–¹æ³•å¯¼èˆªåˆ°ä¸‹ä¸€é¡µ
        rendition.next().then(function() {
          // å¯¼èˆªæˆåŠŸåæ›´æ–°å½“å‰ä½ç½®
          setTimeout(updateReadingPosition, 100);
        }).catch(function() {
          // å·²ç»æ˜¯æœ€åä¸€é¡µ
        });
      }

      // å°†å¯¼èˆªå‡½æ•°æ·»åŠ åˆ°windowå¯¹è±¡ï¼Œä½¿å…¶åœ¨æ‰€æœ‰ä½œç”¨åŸŸä¸­å¯ç”¨
      window.navigatePrev = navigatePrev;
      window.navigateNext = navigateNext;

      // èŠ‚æµå‡½æ•° - ç”¨äºé™åˆ¶å‡½æ•°æ‰§è¡Œé¢‘ç‡
      function throttle(func, wait) {
        let lastTime = 0;
        return function() {
          const now = Date.now();
          if (now - lastTime >= wait) {
            lastTime = now;
            func.apply(this, arguments);
          }
        };
      }

      // å¤„ç†çª—å£å¤§å°è°ƒæ•´
      function handleResize() {
        if (!book || !rendition) {
          return;
        }

        // ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„rerenderBookå‡½æ•°é‡æ–°æ¸²æŸ“
        rerenderBook();

        // åœ¨æ‹–åŠ¨ç»“æŸåè¿›è¡Œä¸€æ¬¡å®Œæ•´æ¸²æŸ“
        // è¿™æ˜¯ä¸ºäº†ç¡®ä¿åœ¨æ‹–åŠ¨ç»“æŸåå†…å®¹å®Œå…¨æ­£ç¡®
        if (window.finalResizeTimer) {
          clearTimeout(window.finalResizeTimer);
        }
        window.finalResizeTimer = setTimeout(rerenderBook, 300); // æ‹–åŠ¨ç»“æŸå300msè¿›è¡Œæœ€ç»ˆæ¸²æŸ“
      }

      // ä½¿ç”¨èŠ‚æµå‡½æ•°åŒ…è£…handleResizeï¼Œé™åˆ¶æ‰§è¡Œé¢‘ç‡
      const throttledResize = throttle(handleResize, 50); // 50msçš„èŠ‚æµé—´éš”

      // å°†handleFileå‡½æ•°æ·»åŠ åˆ°windowå¯¹è±¡ï¼Œä½¿å…¶åœ¨å…¨å±€å¯ç”¨
      window.handleFile = handleFileInternal;

      // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ–‡ä»¶
      if (window._pendingFile) {
        console.log('å¤„ç†å¾…å¤„ç†çš„æ–‡ä»¶:', window._pendingFile.name);
        handleFileInternal(window._pendingFile);
        window._pendingFile = null;
      }
    });
  </script>
</body>
</html>
